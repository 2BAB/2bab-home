<html lang="zh" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="构建指北 #7 debuggable 属性无效" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://2bab.me/zh/blog/2017-09-19-daily-of-agp-debuggable-not-work/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://2bab.me/">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>构建指北 #7 debuggable 属性无效 | 2BAB&#39;s Blog</title>
  
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NFRNXW3SHS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NFRNXW3SHS');
</script>

<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/zh">2BAB&#39;s Blog</a>
    </div>
    <h1>构建指北 #7 debuggable 属性无效</h1>
    <div class="italic text-gray-500">
      2017/09/19
    </div>
    <div>
      <p><em>『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。以发现问题解决问题为出发点，传递新知提高生产效率为落脚点。</em></p>
<h3 id="%E9%97%AE%E9%A2%98%E5%9B%9E%E9%A1%BE" tabindex="-1">问题回顾</h3>
<p>不久前，在接手手头上这个老工程时，发现 <code>build.gradle</code> 中设置 <code>debuggable</code> 属性是无效的，只能手动在 <code>AndroidManifest.xml</code> 的 <code>application</code> 节点写死该属性（之前团队里就这样默默干了两年，发版前去掉这个属性，发版后再加上...），最近得空花了两三个周末研究了下缘由。</p>
<p>默认看此文章的人已经知道这点：</p>
<blockquote>
<p>Android 系统判断一个 App 是否可 Debug 的标准是，AndroidManifest.xml 中的  application 节点是否存在 debuggable 属性，并且其值为 true。（可参考<a href="https://developer.android.com/guide/topics/manifest/application-element.html#android:debuggable">官方文档</a>）</p>
</blockquote>
<p>&lt;!--more--&gt;</p>
<h3 id="%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-%26-%E6%BA%90%E7%A0%81%E9%87%8D%E7%8E%B0" tabindex="-1">问题分析 &amp; 源码重现</h3>
<h4 id="0x01" tabindex="-1">0x01</h4>
<p>从 <code>buildType</code> 的 <code>debuggable</code> 属性开始分析追踪，既然我们知道 <code>debuggable</code> 其实会作用于 Manifest 的属性，那就找找跟 Manifest 相关的流程。先后看了 Android Gradle Plugin 中 <code>process{variant}Manifest</code>、<code>process{variant}Resources </code>、<code>package{variant}</code> 等 task 的流程，没有发现什么异常（此处不一一展开）。不过倒是对他们的中间生成产物有了些了解：</p>
<ul>
<li><code>process{variant}Manifest</code> 的 <code>AndroidManifest.xml</code> 中间产物位于  ./app/build/intermediates/manifests 中，分为 instant-run 和 其他 variant （debug、release、etc.）等各种文件夹；</li>
<li><code>process{variant}Resources</code> 的 <code>AndroidManifest.xml</code> 位于 ./app/build/intermediates/res/resources-debug.ap_ 的压缩包中（事实上一开始没有看这个 task，是在看其他 task 的中间产物时发现这个 task 其实有 <code>AndroidManifest.xml</code> 的产物）；</li>
<li><code>package{variant}</code> 的 <code>AndroidManifest.xml</code> 其实就是最后 apk 包中的文件了；</li>
</ul>
<p>除此之外，没看到有直接对 <code>AndroidManifest.xml</code> 中写入 <code>debuggable</code> 的操作（merge 除外）。</p>
<h4 id="0x02" tabindex="-1">0x02</h4>
<p>拿一个新建的工程和问题工程作比对发现：</p>
<ul>
<li>新建工程：<code>process{variant}Manifest</code> 的产物中没有  <code>debuggable</code> 的属性，却在 <code>process{variant}Resources</code> 的产物中出现了该属性（debug 状态下为 true），说明内部操作发生在这一步；</li>
<li>问题工程：在所有 task 的  <code>AndroidManifest.xml</code> 产物中，均未出现 <code>debuggable</code> 的值；</li>
</ul>
<p>看来还得再翻翻 <code>process{variant}Resources</code>，这其中主要是调用 aapt 相关的操作，仔细查看发现如下关键代码：</p>
<pre class="language-java"><code class="language-java"><br><span class="token comment">// AaptV1.java </span><br><br><span class="token annotation punctuation">@Override</span><br><span class="token annotation punctuation">@NonNull</span><br><span class="token keyword">protected</span> <span class="token class-name">ProcessInfoBuilder</span> <span class="token function">makePackageProcessBuilder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">AaptPackageConfig</span> config<span class="token punctuation">)</span><br>        <span class="token keyword">throws</span> <span class="token class-name">AaptException</span> <span class="token punctuation">{</span><br>    <span class="token class-name">ProcessInfoBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessInfoBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/*<br>     * AaptPackageProcessBuilder had this code below, but nothing was ever added to<br>     * mEnvironment.<br>     */</span><br>    <span class="token comment">//builder.addEnvironments(mEnvironment);</span><br><br>    builder<span class="token punctuation">.</span><span class="token function">setExecutable</span><span class="token punctuation">(</span><span class="token function">getAaptExecutablePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    builder<span class="token punctuation">.</span><span class="token function">addArgs</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span>省略无关紧要的一部分代码<span class="token punctuation">)</span><br>    <br>    <span class="token comment">// 在此处注入了 buildType 的 debuggable 属性</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isDebuggable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        builder<span class="token punctuation">.</span><span class="token function">addArgs</span><span class="token punctuation">(</span><span class="token string">"--debug-mode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br><br>    <span class="token keyword">return</span> builder<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>可以看到，在处理 aapt 的输入参数时带上了 debug 参数，随即便是调用 aapt 的外部过程，不在 Android Gradle Plugin 的控制范围内。</p>
<h4 id="0x03" tabindex="-1">0x03</h4>
<p>找出 Android SDK 源码，编译一个自己的 aapt（具体可以参考<a href="http://2bab.me/2017/09/19/android-source-development-notes-3/">这里</a>），别忘了在关键地方加上一些 log：</p>
<ul>
<li>先是入口文件，找到对应读取 <code>--debug-mode</code> 的地方，会暂存于一个 bundle 中，并且参数获取正确，为 true，[Main.cpp]:</li>
</ul>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cp<span class="token punctuation">,</span> <span class="token string">"-debug-mode"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"AAPTDEBUG: set debug == true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    bundle<span class="token punctuation">.</span><span class="token function">setDebugMode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<ul>
<li>再者，找到 <code>bundle-&gt;getDebugMode()</code> 的地方，发现这里就是核心部分了，真正把 <code>debuggable</code> 的结果写入到 <code>AndroidManifest.xml</code> 中；但是这里出现错误了—— <strong>application 节点获取不到，为 null</strong>，[Resource.cpp]：</li>
</ul>
<pre class="language-cpp"><code class="language-cpp">status_t <span class="token function">massageManifest</span><span class="token punctuation">(</span>Bundle<span class="token operator">*</span> bundle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>XMLNode<span class="token operator">></span> root<span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>    root <span class="token operator">=</span> root<span class="token operator">-></span><span class="token function">searchElement</span><span class="token punctuation">(</span><span class="token function">String16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">String16</span><span class="token punctuation">(</span><span class="token string">"manifest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"No &lt;manifest> tag.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> UNKNOWN_ERROR<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <br>    <span class="token comment">// ...</span><br>    <br>    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"AAPTDEBUG: bundle->getDebugMode()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bundle<span class="token operator">-></span><span class="token function">getDebugMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"AAPTDEBUG: bundle->getDebugMode() - true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        sp<span class="token operator">&lt;</span>XMLNode<span class="token operator">></span> application <span class="token operator">=</span> root<span class="token operator">-></span><span class="token function">getChildElement</span><span class="token punctuation">(</span><span class="token function">String16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">String16</span><span class="token punctuation">(</span><span class="token string">"application"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>application <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"AAPTDEBUG: application == NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 问题出处，打印出了这行 log</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>application <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"AAPTDEBUG: application != NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addTagAttribute</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> RESOURCES_ANDROID_NAMESPACE<span class="token punctuation">,</span> <span class="token string">"debuggable"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">,</span><br>                        errorOnFailedInsert<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"AAPTDEBUG: error on insert"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">return</span> UNKNOWN_ERROR<span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <br>    <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
<ul>
<li>看看 <code>getChildElement()</code> 的实现，发现上面的代码只会从 root 节点（也就是 manifest 节点）出发去找一级子节点，没有深入地递归查找，如果 application 不是 manifest 的一级子节点，则找不到，[XMLNode.cpp]：</li>
</ul>
<pre class="language-cpp"><code class="language-cpp">sp<span class="token operator">&lt;</span>XMLNode<span class="token operator">></span> <span class="token class-name">XMLNode</span><span class="token double-colon punctuation">::</span><span class="token function">getChildElement</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> tagNamespace<span class="token punctuation">,</span> <span class="token keyword">const</span> String16<span class="token operator">&amp;</span> tagName<span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"AAPTDEBUG: root -> %s\n"</span><span class="token punctuation">,</span> <span class="token function">String8</span><span class="token punctuation">(</span>mElementName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        sp<span class="token operator">&lt;</span>XMLNode<span class="token operator">></span> child <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">itemAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> XMLNode<span class="token double-colon punctuation">::</span>TYPE_ELEMENT<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"AAPTDEBUG: getChildElement-> %s\n"</span><span class="token punctuation">,</span> <span class="token function">String8</span><span class="token punctuation">(</span>child<span class="token operator">-></span>mElementName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> XMLNode<span class="token double-colon punctuation">::</span>TYPE_ELEMENT<br>                <span class="token operator">&amp;&amp;</span> child<span class="token operator">-></span>mNamespaceUri <span class="token operator">==</span> tagNamespace<br>                <span class="token operator">&amp;&amp;</span> child<span class="token operator">-></span>mElementName <span class="token operator">==</span> tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> child<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <br>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p><img src="http://2bab-images.lastmayday.com/blog/2017-09-19-gradle-daily-crash-debuggable-not-work-2.jpg?imageslim" alt=""></p>
<ul>
<li>那最后的问题就只有，为什么 application 节点不是 manifest 的一级子节点，查一下编译出来的二进制 Manifest（./app/build/intermediates/res/resources-debug.ap_ ，为避免敏感信息，这里用 <a href="https://github.com/2BAB/DebuggableTest">DebuggableTest</a> 工程做示例）：</li>
</ul>
<p><img src="http://2bab-images.lastmayday.com/blog/2017-09-19-gradle-daily-crash-debuggable-not-work-1.jpg?imageslim" alt=""></p>
<ul>
<li>真相大白，application 的直接父节点是 namespace！</li>
</ul>
<h4 id="0x04" tabindex="-1">0x04</h4>
<p>查看各类依赖库的 Manifest（build-cache/exploded-aar），查看 Manifest 的合并日志（app/build/outputs/logs/manifest-merger-{variant}-report），结合之前写的一个 Manifest Precheck 插件 <a href="https://github.com/2BAB/Seal">Seal</a>，发现会碰到这个问题，有两种可能：</p>
<ol>
<li>依赖库本身对 namespace 的声明不只在 manifest 节点，例如在 application 节点声明了 android 的 namespace，可以参考我 pub 的这个  <a href="https://github.com/2BAB/DebuggableTest">DebuggableTest</a> 工程；</li>
<li>对 Manifest 合并前（即执行 <code>process{variant}Manifest</code> 前），如果有例如 <a href="https://github.com/2BAB/Seal">Seal</a> 这种对依赖库的 Manifest 做清洗工作，<strong>并且很巧你也用了 <code>groovy.util</code> 下的 XML 类库做 XML 解析和输出，那么恭喜你，这个库有几率会导致你的各种节点出现重复的 namespace，比如 uses-sdk 、application</strong>，不过我还没认真去排查到底什么情况下会出现这样的问题，目前实验中也只有少量的样本会这样，暂时没发现他们的共通点。</li>
</ol>
<h3 id="%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" tabindex="-1">解决方案</h3>
<ul>
<li>
<p>使用自定义的 aapt，改一行代码即可解决此类问题：将搜索 application 节点的方法从 <code>sp&lt;XMLNode&gt; XMLNode::getChildElement(const String16&amp; tagNamespace, const String16&amp; tagName)</code> 改为另外一个内建的方法 <code>sp&lt;XMLNode&gt; XMLNode::searchElement(const String16&amp; tagNamespace, const String16&amp; tagName)</code>，原因是 searchElement 的实现是会 for 循环查找所有深度子节点：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Resource.cpp</span><br><br> status_t <span class="token function">massageManifest</span><span class="token punctuation">(</span>Bundle<span class="token operator">*</span> bundle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>XMLNode<span class="token operator">></span> root<span class="token punctuation">)</span><br> <span class="token punctuation">{</span><br>     root <span class="token operator">=</span> root<span class="token operator">-></span><span class="token function">searchElement</span><span class="token punctuation">(</span><span class="token function">String16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">String16</span><span class="token punctuation">(</span><span class="token string">"manifest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>     <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"No &lt;manifest> tag.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token keyword">return</span> UNKNOWN_ERROR<span class="token punctuation">;</span><br>     <span class="token punctuation">}</span><br> <br>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br> <br>     <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"AAPTDEBUG: bundle->getDebugMode()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>     <span class="token keyword">if</span> <span class="token punctuation">(</span>bundle<span class="token operator">-></span><span class="token function">getDebugMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"AAPTDEBUG: bundle->getDebugMode() - true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token comment">// 改掉查找方法！</span><br>         sp<span class="token operator">&lt;</span>XMLNode<span class="token operator">></span> application <span class="token operator">=</span> root<span class="token operator">-></span><span class="token function">searchElement</span><span class="token punctuation">(</span><span class="token function">String16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">String16</span><span class="token punctuation">(</span><span class="token string">"application"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br>         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br>     <span class="token punctuation">}</span><br>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// XMLNode.cpp</span><br><br> sp<span class="token operator">&lt;</span>XMLNode<span class="token operator">></span> <span class="token class-name">XMLNode</span><span class="token double-colon punctuation">::</span><span class="token function">searchElement</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> tagNamespace<span class="token punctuation">,</span> <span class="token keyword">const</span> String16<span class="token operator">&amp;</span> tagName<span class="token punctuation">)</span><br> <span class="token punctuation">{</span><br> <br>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> XMLNode<span class="token double-colon punctuation">::</span>TYPE_ELEMENT<br>             <span class="token operator">&amp;&amp;</span> mNamespaceUri <span class="token operator">==</span> tagNamespace<br>             <span class="token operator">&amp;&amp;</span> mElementName <span class="token operator">==</span> tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br>     <span class="token punctuation">}</span><br>     <span class="token comment">// 递归实现避免上述问题</span><br>     <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>         sp<span class="token operator">&lt;</span>XMLNode<span class="token operator">></span> found <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">itemAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">searchElement</span><span class="token punctuation">(</span>tagNamespace<span class="token punctuation">,</span> tagName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>         <span class="token keyword">if</span> <span class="token punctuation">(</span>found <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>             <span class="token keyword">return</span> found<span class="token punctuation">;</span><br>         <span class="token punctuation">}</span><br>     <span class="token punctuation">}</span><br> <br>     <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><br> <span class="token punctuation">}</span></code></pre>
</li>
<li>
<p>或者使用新版的 <a href="https://github.com/2BAB/Seal">Seal</a> 插件 v1.1.0 ，增加了一个配置项 <code>xmlnsSweep</code>，会在执行 <code>process{variant}Manifest</code> 之后，对其产物进行 xmlns 的清洗，避免在 manifest 节点外出现不必要的 namespace 声明，详细使用说明请参考 <a href="https://github.com/2BAB/Seal">Seal</a> 仓库的 README（注意，目前使用 Seal 请一定要开启并配置 <code>xmlnsSweep</code>，因为不能保证所有的依赖库都不会在 Precheck 中出问题）</p>
</li>
</ul>
<h3 id="%E7%BB%93%E8%AE%BA" tabindex="-1">结论</h3>
<p>这大概是我今年研究过的最麻烦的问题了，链路长，大坑小坑不断，有 Google 挖的，有 Groovy 挖的，目前正在去给他们提 issue 的路上...</p>
<p>铛！更新 issue 地址： <a href="https://issuetracker.google.com/issues/66074488">https://issuetracker.google.com/issues/66074488</a> ！</p>
<p><em>欢迎关注我的<a href="/about">公众号和微博</a>。</em></p>

    </div>
    <hr />
      <div class="text-sm text-center">
        评论和交流请发送邮件到 xx2bab@gmail.com
      </div>
      <hr />
     <div class="text-center">
  <img class="w-64 inline-block" src="https://s2.loli.net/2023/05/13/FKYi5STEtmNZd8W.jpg" alt="Wechat Donate QACode" />
  <div class="text-sm">
    通过微信扫描赞赏码赞助此文
  </div>
</div> 
    <footer class="text-sm py-12 text-gray-500 text-center">
  
  <p><a href="/">ENG</a> / <a href="/zh">中文</a></p>
  
  2BAB's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>