<html lang="zh" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="移植 Mediapipe Demo 到 Kotlin Multiplatform (2) Object Detection" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://2bab.me/zh/blog/2024-10-04-on-device-model-integration-kmp-2/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://2bab.me/">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>移植 Mediapipe Demo 到 Kotlin Multiplatform (2) Object Detection | 2BAB&#39;s Blog</title>
  
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NFRNXW3SHS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NFRNXW3SHS');
</script>

<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/zh">2BAB&#39;s Blog</a>
    </div>
    <h1>移植 Mediapipe Demo 到 Kotlin Multiplatform (2) Object Detection</h1>
    <div class="italic text-gray-500">
      2024/10/04
    </div>
    <div>
      <p>继上一篇移植了 Mediapipe 的 LLM Inference 后，这篇文章我们将继续探索 Object Detection Demo 的移植。通过本文你将了解到：</p>
<ol>
<li><strong>移植 Mediapipe 的 Object Detection Android 官方 Demo 到 KMP，支持在 iOS 上运行。</strong> 项目地址：<a href="https://github.com/2BAB/MediaPiper/tree/object-detection">https://github.com/2BAB/MediaPiper/tree/object-detection</a></li>
<li><strong>Compose Multiplatform 与 iOS 原生控件的集成与交互（Camera Preview），包括权限申请。</strong></li>
<li><strong>在 KMP 使用依赖注入 iOS 控件的小技巧（基于 Koin）。</strong></li>
<li><strong>该 Demo 里两种 Object Detection 算法的简单背景知识。</strong></li>
</ol>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-camera-ppt.png?imageslim" alt=""></p>
<h2 id="object-detection-android-sample" tabindex="-1">Object Detection Android Sample</h2>
<p>首先，我们先打开 Object Detection 的原版工程，发现其 Android 部分既有 android.view.View 版本的实现，也有 Jetpack Compose 的版本。因此我们延续上一篇的方式，基于 Jetpack Compose 的版本直接移植到 KMP 上。</p>
<p>接着，仔细体验该 App 会发现其复杂度更高。LLM Inference 中的 SDK 仅仅是提供文本的推理接口，可直接在 Kotlin 层封装对应平台的 SDK 方便抽象（尽管因为一些 cinterop 支持原因我们最后用了备用方案），UI 上则完全复用。但 Object Detection 是基于图像的实时处理，演示里涉及摄像头实时检测、本地视频的检测、本地图片的检测三种。<strong>摄像头预览</strong>的需求一般都<strong>强依赖于平台实现</strong>，播放器在渲染层面也鲜有自绘（即使用平台 Native 方案）。</p>
<p><img src="https://2bab-images.lastmayday.com/Screenshot%202024-10-05%20at%201.25.14%E2%80%AFPM.png?imageslim" alt=""></p>
<p>小结，在开始设计时我们就得考虑<strong>把 Compose Multiplatform (CMP) 难以实现的部分留出</strong>（例如上图中的 CameraView），<strong>抽象成独立的 expect  Composable 函数留给两端各自实现</strong>。而为了方便学习需减少 Demo 的规模，我们也决定只实现 CameraView 的部分，把 Gallery (Video + Image) 的部分留给大家去尝试。实际上，只要掌握了 Camera Preview 的嵌入方法，其他两部分也可以参照实现，包括 Compose 和 UiKit 的交互、iOS 权限申请等。</p>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-options-layers3.png?imageslim" alt=""></p>
<p>结合 iOS 版的 Demo 交叉比对，我们把 CameraView 有关的 UI 层整理成了四个部分，如上图所示。其中：</p>
<ul>
<li>Camera Preview 层一定是交由两端各自实现。</li>
<li>ResultOverlay 即各种结果的方框绘制，可以考虑在 Common 层实现，但涉及到其与 Camera Preview 的图层匹配（因 Camera Preview 的大小根据镜头的不同会有不同的比例选项）、坐标转换，较为复杂，本次 Demo 继续交由两端各自实现。</li>
<li>Scaffold 和 Inference Time Label 在 Common 层实现。</li>
</ul>
<h2 id="%E7%A7%BB%E6%A4%8D%E6%B5%81%E7%A8%8B" tabindex="-1">移植流程</h2>
<h3 id="%E7%A7%BB%E6%A4%8D%E4%B8%BB%E4%BD%93%E7%9A%84-ui-%E5%92%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" tabindex="-1">移植主体的 UI 和数据结构</h3>
<p>我们在上一节的基础上继续在 Mediapiper 工程中增加一个新文件夹 <em>objectdetection</em>。有了上一节的经验，我们发现其实很多 UI 的内容都不复杂——除了这节的重点，相机预览界面。因此，我们可以先行把除了 <code>camera</code> 和 <code>gallery</code> 的文件都移动过来：</p>
<p><img src="https://2bab-images.lastmayday.com/202410121605950.png?imageslim" alt=""></p>
<p>此处需要的修改分为两块：</p>
<ol>
<li>数据和逻辑部分：
<ol>
<li>我们采集原来的 SDK 中的 <code>ObjectDetectionResult</code> 属性声明，创建了一个 Common 版本的 data class，也包括其用到的各种附属类型。如此一来，两边的 SDK 返回结果都可以通过简单转换直接替换成 Common 版本的，不管是要显示推理时间、统一采样埋点，甚至为以后把 <code>ResultOverlay</code> 搬来 Common 做好了准备。</li>
<li>一些工具类和默认值枚举也被一并移至 Common 层，并且基本不需要修改，只要把推理结果的类置换成上述 Common 版本的。</li>
</ol>
</li>
<li>UI 部分：
<ol>
<li>一些统一的修改和上一节完全相同，<code>R</code> 引用改 <code>Res</code>，主题换成上一节统一的，一些简单的 Import 包修改。</li>
<li>而特别的部分在于该 Demo 没有使用 CMP 版本的 Navigation，所以在 Home 和 Option 页面切换只是在顶层做了一个简单的 <code>if...else...</code>。</li>
</ol>
</li>
</ol>
<p>至此已经可以运行一个不含相机功能的应用了，下图演示了这些 CMP 代码在 iOS 上运行时的两个页面。</p>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-no-cameras.jpg?imageslim" alt=""></p>
<h3 id="%E9%9B%86%E6%88%90-cameraview-%E5%8A%9F%E8%83%BD" tabindex="-1">集成 CameraView 功能</h3>
<p>如上文分析我们需要拆除 CameraView 的部分用 Native 实现，因此在 Common 的 <code>CameraView</code> 里我们使用了两个 <code>expect</code> 的 Composable 函数 <code>CameraPermissionControl</code> 和 <code>CameraPreview</code>：</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Composable</span><br><span class="token keyword">fun</span> <span class="token function">CameraView</span><span class="token punctuation">(</span><br>    threshold<span class="token operator">:</span> Float<span class="token punctuation">,</span><br>    maxResults<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    delegate<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    mlModel<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    setInferenceTime<span class="token operator">:</span> <span class="token punctuation">(</span>newInferenceTime<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    CameraPermissionControl <span class="token punctuation">{</span><br>        <span class="token function">CameraPreview</span><span class="token punctuation">(</span><br>            threshold<span class="token punctuation">,</span><br>            maxResults<span class="token punctuation">,</span><br>            delegate<span class="token punctuation">,</span><br>            mlModel<span class="token punctuation">,</span><br>            setInferenceTime<span class="token punctuation">,</span><br>            onDetectionResultUpdate <span class="token operator">=</span> <span class="token punctuation">{</span> detectionResults <span class="token operator">-></span><br>               <span class="token operator">..</span><span class="token punctuation">.</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">expect</span> <span class="token keyword">fun</span> <span class="token function">CameraPermissionControl</span><span class="token punctuation">(</span>PermissionGrantedContent<span class="token operator">:</span>  <span class="token annotation builtin">@Composable</span> <span class="token annotation builtin">@UiComposable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span><br>```kotlin<br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">expect</span> <span class="token keyword">fun</span> <span class="token function">CameraPreview</span><span class="token punctuation">(</span><br>    threshold<span class="token operator">:</span> Float<span class="token punctuation">,</span><br>    maxResults<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    delegate<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    mlModel<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    setInferenceTime<span class="token operator">:</span> <span class="token punctuation">(</span>newInferenceTime<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br>    onDetectionResultUpdate<span class="token operator">:</span> <span class="token punctuation">(</span>result<span class="token operator">:</span> ObjectDetectionResult<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<br><span class="token punctuation">)</span></code></pre>
<h4 id="android-%E4%BE%A7%E7%9A%84-cameraview-%E5%AE%9E%E7%8E%B0" tabindex="-1">Android 侧的 CameraView 实现</h4>
<p>Android 端的实现十分简单，直接将原有的 Jetpack Compose 代码拷贝过来：</p>
<pre class="language-swift"><code class="language-swift"><span class="token comment">// Android implementation</span><br><span class="token attribute atrule">@OptIn</span><span class="token punctuation">(</span><span class="token class-name">ExperimentalPermissionsApi</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><br><span class="token attribute atrule">@Composable</span><br>actual fun <span class="token class-name">CameraPermissionControl</span><span class="token punctuation">(</span><br>   <span class="token class-name">PermissionGrantedContent</span><span class="token punctuation">:</span>  <span class="token attribute atrule">@Composable</span> <span class="token attribute atrule">@UiComposable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Unit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <br>    val storagePermissionState<span class="token punctuation">:</span> <span class="token class-name">PermissionState</span> <span class="token operator">=</span><br>        <span class="token function">rememberPermissionState</span><span class="token punctuation">(</span><span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">CAMERA</span><span class="token punctuation">)</span><br>    <span class="token class-name">LaunchedEffect</span><span class="token punctuation">(</span>key1 <span class="token operator">=</span> <span class="token class-name">Unit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storagePermissionState<span class="token punctuation">.</span>hasPermission<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            storagePermissionState<span class="token punctuation">.</span><span class="token function">launchPermissionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storagePermissionState<span class="token punctuation">.</span>hasPermission<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token class-name">Text</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"No Storage Permission!"</span></span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token class-name">PermissionGrantedContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token attribute atrule">@Composable</span><br>actual fun <span class="token class-name">CameraPreview</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span> <span class="token comment">// Some properties' definition</span><br>    <br>    <span class="token class-name">DisposableEffect</span><span class="token punctuation">(</span><span class="token class-name">Unit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        onDispose <span class="token punctuation">{</span><br>            active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>            cameraProviderFuture<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unbindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Next we describe the UI of this camera view.</span><br>    <span class="token class-name">BoxWithConstraints</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <br>        val cameraPreviewSize <span class="token operator">=</span> <span class="token function">getFittedBoxSize</span><span class="token punctuation">(</span><br>            containerSize <span class="token operator">=</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><br>                width <span class="token operator">=</span> this<span class="token punctuation">.</span>maxWidth<span class="token punctuation">.</span>value<span class="token punctuation">,</span><br>                height <span class="token operator">=</span> this<span class="token punctuation">.</span>maxHeight<span class="token punctuation">.</span>value<span class="token punctuation">,</span><br>            <span class="token punctuation">)</span><span class="token punctuation">,</span><br>            boxSize <span class="token operator">=</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><br>                width <span class="token operator">=</span> frameWidth<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                height <span class="token operator">=</span> frameHeight<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br><br>        <span class="token class-name">Box</span><span class="token punctuation">(</span><br>            <span class="token class-name">Modifier</span><br>                <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span>cameraPreviewSize<span class="token punctuation">.</span>width<span class="token punctuation">.</span>dp<span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span>cameraPreviewSize<span class="token punctuation">.</span>height<span class="token punctuation">.</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token comment">// We're using CameraX to use the phone's camera, and since it doesn't have a prebuilt</span><br>            <span class="token comment">// composable in Jetpack Compose, we use AndroidView to implement it</span><br>            <span class="token class-name">AndroidView</span><span class="token punctuation">(</span><br>                factory <span class="token operator">=</span> <span class="token punctuation">{</span> ctx <span class="token operator">-></span>                    <br>                    val previewView <span class="token operator">=</span> <span class="token class-name">PreviewView</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><br>                    val executor <span class="token operator">=</span> <span class="token class-name">ContextCompat</span><span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><br>                    cameraProviderFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>                        val cameraProvider <span class="token operator">=</span> cameraProviderFuture<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                        val preview <span class="token operator">=</span> <span class="token class-name">Preview</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>also <span class="token punctuation">{</span><br>                            it<span class="token punctuation">.</span><span class="token function">setSurfaceProvider</span><span class="token punctuation">(</span>previewView<span class="token punctuation">.</span>surfaceProvider<span class="token punctuation">)</span><br>                        <span class="token punctuation">}</span><br><br>                        val cameraSelector <span class="token operator">=</span> <span class="token class-name">CameraSelector</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                            <span class="token punctuation">.</span><span class="token function">requireLensFacing</span><span class="token punctuation">(</span><span class="token class-name">CameraSelector</span><span class="token punctuation">.</span><span class="token constant">LENS_FACING_BACK</span><span class="token punctuation">)</span><br>                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>                        <span class="token comment">// We instantiate an image analyser to apply some transformations on the</span><br>                        <span class="token comment">// input frame before feeding it to the object detector</span><br>                        val imageAnalyzer <span class="token operator">=</span><br>                            <span class="token class-name">ImageAnalysis</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                                <span class="token punctuation">.</span><span class="token function">setTargetAspectRatio</span><span class="token punctuation">(</span><span class="token class-name">AspectRatio</span><span class="token punctuation">.</span>RATIO_4_3<span class="token punctuation">)</span><br>                                <span class="token punctuation">.</span><span class="token function">setBackpressureStrategy</span><span class="token punctuation">(</span><span class="token class-name">ImageAnalysis</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_KEEP_ONLY_LATEST</span><span class="token punctuation">)</span><br>                                <span class="token punctuation">.</span><span class="token function">setOutputImageFormat</span><span class="token punctuation">(</span><span class="token class-name">ImageAnalysis</span><span class="token punctuation">.</span>OUTPUT_IMAGE_FORMAT_RGBA_8888<span class="token punctuation">)</span><br>                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>                        <span class="token comment">// Now we're ready to apply object detection. For a better performance, we</span><br>                        <span class="token comment">// execute the object detection process in a new thread.</span><br>                        val backgroundExecutor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>                        backgroundExecutor<span class="token punctuation">.</span>execute <span class="token punctuation">{</span><br><br>                            <span class="token comment">// To apply object detection, we use our ObjectDetectorHelper class,</span><br>                            <span class="token comment">// which abstracts away the specifics of using MediaPipe  for object</span><br>                            <span class="token comment">// detection from the UI elements of the app</span><br>                            val objectDetectorHelper <span class="token operator">=</span><br>                                <span class="token class-name">AndroidObjectDetector</span><span class="token punctuation">(</span><br>                                    context <span class="token operator">=</span> ctx<span class="token punctuation">,</span><br>                                    threshold <span class="token operator">=</span> threshold<span class="token punctuation">,</span><br>                                    currentDelegate <span class="token operator">=</span> delegate<span class="token punctuation">,</span><br>                                    currentModel <span class="token operator">=</span> mlModel<span class="token punctuation">,</span><br>                                    maxResults <span class="token operator">=</span> maxResults<span class="token punctuation">,</span>                                <br>                                    objectDetectorListener <span class="token operator">=</span> <span class="token class-name">ObjectDetectorListener</span><span class="token punctuation">(</span><br>                                        onErrorCallback <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> <span class="token operator">-></span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                                        onResultsCallback <span class="token operator">=</span> <span class="token punctuation">{</span><br>                                            <span class="token comment">// On receiving results, we now have the exact camera</span><br>                                            <span class="token comment">// frame dimensions, so we set them here</span><br>                                            frameHeight <span class="token operator">=</span> it<span class="token punctuation">.</span>inputImageHeight<br>                                            frameWidth <span class="token operator">=</span> it<span class="token punctuation">.</span>inputImageWidth<br><br>                                            <span class="token comment">// Then we check if the camera view is still active,</span><br>                                            <span class="token comment">// if so, we set the state of the results and</span><br>                                            <span class="token comment">// inference time.</span><br>                                            <span class="token keyword">if</span> <span class="token punctuation">(</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                                                results <span class="token operator">=</span> it<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                                                <span class="token function">setInferenceTime</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>inferenceTime<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>                                            <span class="token punctuation">}</span><br>                                        <span class="token punctuation">}</span><br>                                    <span class="token punctuation">)</span><span class="token punctuation">,</span><br>                                    runningMode <span class="token operator">=</span> <span class="token class-name">RunningMode</span><span class="token punctuation">.</span><span class="token constant">LIVE_STREAM</span><br>                                <span class="token punctuation">)</span><br><br>                            <span class="token comment">// Now that we have our ObjectDetectorHelper instance, we set is as an</span><br>                            <span class="token comment">// analyzer and start detecting objects from the camera live stream</span><br>                            imageAnalyzer<span class="token punctuation">.</span><span class="token function">setAnalyzer</span><span class="token punctuation">(</span><br>                                backgroundExecutor<span class="token punctuation">,</span><br>                                objectDetectorHelper<span class="token punctuation">:</span><span class="token punctuation">:</span>detectLivestreamFrame<br>                            <span class="token punctuation">)</span><br>                        <span class="token punctuation">}</span><br><br>                        <span class="token comment">// We close any currently open camera just in case, then open up</span><br>                        <span class="token comment">// our own to be display the live camera feed</span><br>                        cameraProvider<span class="token punctuation">.</span><span class="token function">unbindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                        cameraProvider<span class="token punctuation">.</span><span class="token function">bindToLifecycle</span><span class="token punctuation">(</span><br>                            lifecycleOwner<span class="token punctuation">,</span><br>                            cameraSelector<span class="token punctuation">,</span><br>                            imageAnalyzer<span class="token punctuation">,</span><br>                            preview<br>                        <span class="token punctuation">)</span><br>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><br>                    <span class="token comment">// We return our preview view from the AndroidView factory to display it</span><br>                    previewView<br>                <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                modifier <span class="token operator">=</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token punctuation">)</span><br><br>            <span class="token comment">// Finally, we check for current results, if there's any, we display the results overlay</span><br>            results<span class="token operator">?</span><span class="token punctuation">.</span><span class="token keyword">let</span> <span class="token punctuation">{</span><br>                <span class="token class-name">ResultsOverlay</span><span class="token punctuation">(</span><br>                    results <span class="token operator">=</span> it<span class="token punctuation">,</span><br>                    frameWidth <span class="token operator">=</span> frameWidth<span class="token punctuation">,</span><br>                    frameHeight <span class="token operator">=</span> frameHeight<br>                <span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h4 id="ios-%E4%BE%A7%E7%9A%84-cameraview-%E5%AE%9E%E7%8E%B0" tabindex="-1">iOS 侧的 CameraView 实现</h4>
<p>iOS 则稍微需要一些精力。对于相机权限控制，我们直接在这个 Composable 函数中调用 iOS 的 <code>platform.AVFoundation</code> 相关 API，异步发起请求然后根据结果显示加载中、失败、或成功时直接显示相机预览。可以看到我们做的 iOS 实现已十分完善，考虑到了三个不同场景 :D</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token operator">..</span><span class="token punctuation">.</span><br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>AVFoundation<span class="token punctuation">.</span>AVAuthorizationStatusAuthorized<br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>AVFoundation<span class="token punctuation">.</span>AVAuthorizationStatusDenied<br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>AVFoundation<span class="token punctuation">.</span>AVAuthorizationStatusNotDetermined<br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>AVFoundation<span class="token punctuation">.</span>AVAuthorizationStatusRestricted<br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>AVFoundation<span class="token punctuation">.</span>AVCaptureDevice<br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>AVFoundation<span class="token punctuation">.</span>AVMediaTypeVideo<br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>AVFoundation<span class="token punctuation">.</span>authorizationStatusForMediaType<br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>AVFoundation<span class="token punctuation">.</span>requestAccessForMediaType<br><span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>resume<br><span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>suspendCoroutine<br><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">actual</span> <span class="token keyword">fun</span> <span class="token function">CameraPermissionControl</span><span class="token punctuation">(</span>PermissionGrantedContent<span class="token operator">:</span>  <span class="token annotation builtin">@Composable</span> <span class="token annotation builtin">@UiComposable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> hasCameraPermission <span class="token keyword">by</span> remember <span class="token punctuation">{</span> mutableStateOf<span class="token operator">&lt;</span>Boolean<span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br><br>    <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        hasCameraPermission <span class="token operator">=</span> <span class="token function">requestCameraAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">when</span> <span class="token punctuation">(</span>hasCameraPermission<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token boolean">true</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            <span class="token function">PermissionGrantedContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token boolean">false</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Camera permission denied. Please grant access from settings."</span></span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Requesting camera permission..."</span></span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><br><span class="token keyword">private</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">requestCameraAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> suspendCoroutine <span class="token punctuation">{</span> continuation <span class="token operator">-></span><br>    <span class="token keyword">val</span> authorizationStatus <span class="token operator">=</span> AVCaptureDevice<span class="token punctuation">.</span><span class="token function">authorizationStatusForMediaType</span><span class="token punctuation">(</span>AVMediaTypeVideo<span class="token punctuation">)</span><br><br>    <span class="token keyword">when</span> <span class="token punctuation">(</span>authorizationStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        AVAuthorizationStatusNotDetermined <span class="token operator">-></span> <span class="token punctuation">{</span><br>            AVCaptureDevice<span class="token punctuation">.</span><span class="token function">requestAccessForMediaType</span><span class="token punctuation">(</span>AVMediaTypeVideo<span class="token punctuation">)</span> <span class="token punctuation">{</span> granted <span class="token operator">-></span><br>                continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>granted<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        AVAuthorizationStatusRestricted<span class="token punctuation">,</span> AVAuthorizationStatusDenied <span class="token operator">-></span> <span class="token punctuation">{</span><br>            continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        AVAuthorizationStatusAuthorized <span class="token operator">-></span> <span class="token punctuation">{</span><br>            continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>然后来到核心的相机预览功能。从 CMP 的<a href="https://www.jetbrains.com/help/kotlin-multiplatform-dev/compose-uikit-integration.html">文档</a>中我们知道，使用 <code>UIKitView</code> 即可在 Composable 函数中嵌入一个 iOS 的 View。</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// Example 1</span><br><span class="token function">UIKitView</span><span class="token punctuation">(</span><br>    factory <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function">MKMapView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span><br><br><span class="token comment">// Example 2</span><br><span class="token annotation builtin">@OptIn</span><span class="token punctuation">(</span>ExperimentalForeignApi<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">fun</span> <span class="token function">UseUITextField</span><span class="token punctuation">(</span>modifier<span class="token operator">:</span> Modifier <span class="token operator">=</span> Modifier<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> message <span class="token keyword">by</span> remember <span class="token punctuation">{</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Hello, World!"</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>    <span class="token function">UIKitView</span><span class="token punctuation">(</span><br>        factory <span class="token operator">=</span> <span class="token punctuation">{</span><br>            <span class="token keyword">val</span> textField <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">UITextField</span><span class="token punctuation">(</span><span class="token function">CGRectMake</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token annotation builtin">@ObjCAction</span><br>                <span class="token keyword">fun</span> <span class="token function">editingChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    message <span class="token operator">=</span> text <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">""</span></span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>            textField<span class="token punctuation">.</span><span class="token function">addTarget</span><span class="token punctuation">(</span><br>                target <span class="token operator">=</span> textField<span class="token punctuation">,</span><br>                action <span class="token operator">=</span> <span class="token function">NSSelectorFromString</span><span class="token punctuation">(</span>textField<span class="token operator">::</span>editingChanged<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span><br>                forControlEvents <span class="token operator">=</span> UIControlEventEditingChanged<br>            <span class="token punctuation">)</span><br>            textField<br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        modifier <span class="token operator">=</span> modifier<span class="token punctuation">.</span><span class="token function">fillMaxWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        update <span class="token operator">=</span> <span class="token punctuation">{</span> textField <span class="token operator">-></span><br>            textField<span class="token punctuation">.</span>text <span class="token operator">=</span> message<br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>仔细观察这两个示例会发现其使用的都是默认 UIKit 控件，而非工程自定义的；对应的引用则是 JetBrains 提前转换了相关的代码接口到 Kotlin，例如  <code>platform.UIKit.UITextField</code> 默认可以导入到 KMP 工程的 iOS target。但对于我们的工程情况不太相同，我们想要复用的是一个带有识别功能的自定义 <code>CameraPreview</code> 视图。</p>
<p><img src="https://2bab-images.lastmayday.com/202410131137759.png?imageslim" alt=""></p>
<p>换个角度看，KMP 产出的 <code>app.framework</code> 是一个基础共享层，iOS 原生代码依赖于这个库。<strong>从依赖关系上，我们无法直接调用 iOS App 源码中的 <code>CamerePreview</code></strong>。解决方法也不难想法，一般分两种：</p>
<ol>
<li>把相关代码打包成一个独立模块，产出 <code>cameraview.freamework</code>，让 <code>app</code> 依赖它。</li>
<li>iOS App 在初始化 app.framework 时，传入一个 lambda 到 <code>app</code> 用来初始化并返回一个 <code>UIView</code>。</li>
</ol>
<p>此处我们采用第二种方案，定义 <code>IOSCameraPreviewCreator</code> 作为两侧交互的协议。</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// 定义</span><br><span class="token keyword">typealias</span> IOSCameraPreviewCreator <span class="token operator">=</span> <span class="token punctuation">(</span><br>    threshold<span class="token operator">:</span> Float<span class="token punctuation">,</span><br>    maxResults<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    delegate<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    mlModel<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    setInferenceTime<span class="token operator">:</span> <span class="token punctuation">(</span>newInferenceTime<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br>    callback<span class="token operator">:</span> IOSCameraPreviewCallback<br><span class="token punctuation">)</span> <span class="token operator">-></span> UIView<br><br><span class="token keyword">typealias</span> IOSCameraPreviewCallback <span class="token operator">=</span> <span class="token punctuation">(</span>result<span class="token operator">:</span> ObjectDetectionResult<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<br><br><span class="token comment">// 在启动时从 iOS 端传入相关实现，并加入到 Koin 的 Definition</span><br><span class="token keyword">fun</span> <span class="token function">onStartup</span><span class="token punctuation">(</span>iosCameraPreviewCreator<span class="token operator">:</span> IOSCameraPreviewCreator<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    Startup<span class="token punctuation">.</span><span class="token function">run</span> <span class="token punctuation">{</span> koinApp <span class="token operator">-></span><br>        koinApp<span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span><br>            <span class="token function">modules</span><span class="token punctuation">(</span>module <span class="token punctuation">{</span><br>                single <span class="token punctuation">{</span> <span class="token function">LLMOperatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>                single<span class="token operator">&lt;</span>IOSCameraPreviewCreator<span class="token operator">></span> <span class="token punctuation">{</span> iosCameraPreviewCreator <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// 回到 CameraPreview 的实现，我们只要执行注入，</span><br><span class="token comment">// 并 invoke 这个函数获得 UIView 实例。</span><br><span class="token operator">..</span><span class="token punctuation">.</span><br><span class="token keyword">import</span> androidx<span class="token punctuation">.</span>compose<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>viewinterop<span class="token punctuation">.</span>UIKitView<br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>UIKit<span class="token punctuation">.</span>UIView<br><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">actual</span> <span class="token keyword">fun</span> <span class="token function">CameraPreview</span><span class="token punctuation">(</span><br>    threshold<span class="token operator">:</span> Float<span class="token punctuation">,</span><br>    maxResults<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    delegate<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    mlModel<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    setInferenceTime<span class="token operator">:</span> <span class="token punctuation">(</span>newInferenceTime<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br>    onDetectionResultUpdate<span class="token operator">:</span> <span class="token punctuation">(</span>result<span class="token operator">:</span> ObjectDetectionResult<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">val</span> iOSCameraPreviewCreator <span class="token operator">=</span> koinInject<span class="token operator">&lt;</span>IOSCameraPreviewCreator<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token comment">// 和 Android 端集成原生 Camera View 的方式有几分相似</span><br>    <span class="token function">UIKitView</span><span class="token punctuation">(</span><br>        factory <span class="token operator">=</span> <span class="token punctuation">{</span><br>            <span class="token keyword">val</span> iosCameraPreview<span class="token operator">:</span> UIView <span class="token operator">=</span> <span class="token function">iOSCameraPreviewCreator</span><span class="token punctuation">(</span><br>                threshold<span class="token punctuation">,</span><br>                maxResults<span class="token punctuation">,</span><br>                delegate<span class="token punctuation">,</span><br>                mlModel<span class="token punctuation">,</span><br>                setInferenceTime<span class="token punctuation">,</span><br>                onDetectionResultUpdate<span class="token punctuation">)</span><br>            iosCameraPreview<br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        update <span class="token operator">=</span> <span class="token punctuation">{</span> _ <span class="token operator">-></span> <span class="token punctuation">}</span><br>    <span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>上述代码使用 Koin 管理依赖简化了流程。至此 CMP 的部分已经完成，我们顺延启动参数的注入去探究 iOS 的部分。</p>
<pre class="language-swift"><code class="language-swift"><span class="token class-name">MainKt</span><span class="token punctuation">.</span><span class="token function">onStartup</span><span class="token punctuation">(</span>iosCameraPreviewCreator<span class="token punctuation">:</span> <span class="token punctuation">{</span> threshold<span class="token punctuation">,</span> maxResults<span class="token punctuation">,</span> delegate<span class="token punctuation">,</span> mlModel<span class="token punctuation">,</span> onInferenceTimeUpdate<span class="token punctuation">,</span> resultCallback <span class="token keyword">in</span><br>    <span class="token keyword">return</span> <span class="token class-name">IOSCameraView</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><br>        frame<span class="token punctuation">:</span> <span class="token class-name">CGRectMake</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        modelName<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">(</span>truncating<span class="token punctuation">:</span> mlModel<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string-literal"><span class="token string">"EfficientDet-Lite0"</span></span> <span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"EfficientDet-Lite2"</span></span><span class="token punctuation">,</span><br>        maxResults<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">(</span>truncating<span class="token punctuation">:</span> maxResults<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        scoreThreshold<span class="token punctuation">:</span> <span class="token class-name">Float</span><span class="token punctuation">(</span>truncating<span class="token punctuation">:</span> threshold<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        onInferenceTimeUpdate<span class="token punctuation">:</span> onInferenceTimeUpdate<span class="token punctuation">,</span><br>        resultCallback<span class="token punctuation">:</span> resultCallback<br>    <span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>该 <code>IOSCameraView</code> 实际上即原 iOS Demo 中的 <code>CameraViewController</code>，我们仅修改一些初始化和生命周期的内容，并简化掉了参数变化监听的部分以突出核心迁移内容：</p>
<ol>
<li>
<p><strong>生命周期处理</strong>：<code>ViewController</code> 使用 <code>viewDidLoad</code> 等生命周期方法，<code>UIView</code> 则用 <code>didMoveToWindow</code> 处理视图添加或移除时的逻辑。<code>ViewController</code> 通过生命周期管理初始化，而 <code>UIView</code> 提供自定义初始化方法来传递模型和检测参数。</p>
</li>
<li>
<p><strong>子视图设置</strong>  ：<code>ViewController</code> 使用 <code>@IBOutlet</code> 和 Interface Builder，而 <code>UIView</code> 通过 <code>setupView</code> 方法直接创建并添加子视图，手动使用 AutoLayout 设置约束以及手动设置点击事件。</p>
</li>
<li>
<p><strong>回调和委托</strong>：<code>ViewController</code> 使用委托，而 <code>UIView</code> 增加了回调闭包 <code>onInferenceTimeUpdate</code> 和 <code>resultCallback</code>，初始化时传入这些参数并设置好类型转换，方便后面回调到 KMP 层。</p>
</li>
</ol>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-controller-to-view.jpg?imageslim" alt=""></p>
<p>我们同时保留了 <code>OverlayView</code> <code>CameraFeedService</code> <code>ObjectDetectorService</code> 和部分 <code>DefaultConstants</code>，此处不对他们的代码进行修改。其中 <code>ObjectDetectorService</code> 即是对 Object Detection SDK 的封装，如果观察它的 API 调用，会发现其和 iOS 的 Camera API 紧密耦合（<code>CMSampleBuffer</code> 等），说明了其难以在 Common 抽象，呼应了文初对 Camera 相关服务的分析。</p>
<p><img src="https://2bab-images.lastmayday.com/202410131208100.png?imageslim" alt=""></p>
<p>至此，我们就可以把 iOS 端的相机预览加 Object Detection 也跑起来。</p>
<h2 id="%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95" tabindex="-1">简单测试</h2>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-overview-gif.gif?imageslim" alt=""></p>
<p>上方的动图展示了 EfficientDet-Lite0 加 CPU 模式在 iPhone 13mini 执行的效果。官方使用 Pixel 6 CPU/GPU 的测试中，转去 GPU 执行还能再小幅提高一些性能。不难看出，其实时性已足够满足生产环境的需求，同时在准确率方面表现尚可。</p>
<p>随 Demo 工程搭载的可选模型有两个：</p>
<ul>
<li>EfficientDet-Lite0 模型使用 320x320 输入，平衡了延迟和准确性，适合轻量级应用。Demo 中默认搭载了其 float 32 版本的模型。</li>
<li>EfficientDet-Lite2 模型使用 448x448 输入，准确性更高，但速度较慢，适合对准确性要求更高的场景。Demo 中默认搭载了其 float 32 版本的模型。</li>
</ul>
<p>这两种模型均使用包含 150 万个实例和 80 种物体标签的训练集进行训练。</p>
<p><img src="https://2bab-images.lastmayday.com/202410131403617.png?imageslim" alt=""></p>
<h2 id="%E6%80%BB%E7%BB%93" tabindex="-1">总结</h2>
<ul>
<li>一些传统的 ML 模型在移动设备上的应用已经相对成熟，可以应对不少单一和专途的场景。而本文的两个模型亦只有 13~25MB，相比 LLM 的模型动辄 1GB 以上，这类模型完全没有落地的负担。</li>
<li>使用 Compose Multiplatform 内嵌 UiKit 的 View 可以解决很多高性能、需要原生 API 和硬件的情况。</li>
<li>为了尽可能还原 Demo 的效果同时减少迁移成本，<code>ResultOverlay</code> 在本次迁移中虽然已经放到 Common 层，且 iOS 侧也已设置结果回调到 KMP，但 iOS 上依旧使用了原生 View 实现。现实场景中，我们可进一步扩展思考：
<ul>
<li>倘若业务场景简单，例如也是方框识别且全屏展示 camera preview，则可以在 Compose 层简单复用 <code>ResultOverlay</code>。</li>
<li>倘若业务场景复杂，例如视频聊天时的人脸识别加贴图选择和渲染，因业务部分的高复杂度使得复用同一个 StickerOverlay 的价值非常高。这个情况下 Camera Preview 无论大小如何，适配成本反倒都可以接受。另外对于 StickerOverlay 的位置计算，理论上也存在优化的空间，例如采样计算然后中间用插值动画移动。</li>
</ul>
</li>
<li>一些依赖管理的复杂场景包括 UI 视图的注入，借助类似 Koin 的依赖注入框架可大幅简化。</li>
<li>这次迁移的部分还有相册选择、照片与视频解析等等未实现，感兴趣的朋友可以自行添加测试，像读取权限申请、播放器 View 的嵌入和本文的迁移过程会非常类似。</li>
</ul>

    </div>
    <hr />
      <div class="text-sm text-center">
        评论和交流请发送邮件到 xx2bab@gmail.com
      </div>
      <hr />
     <div class="text-center">
  <img class="w-64 inline-block" src="https://s2.loli.net/2023/05/13/FKYi5STEtmNZd8W.jpg" alt="Wechat Donate QACode" />
  <div class="text-sm">
    通过微信扫描赞赏码赞助此文
  </div>
</div> 
    <footer class="text-sm py-12 text-gray-500 text-center">
  
  <p><a href="/">ENG</a> / <a href="/zh">中文</a></p>
  
  2BAB's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>