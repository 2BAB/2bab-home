<html lang="zh" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="插件化笔记 #2 加载插件代码" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://2bab.me/zh/blog/2016-09-18-plugadget-note-2-LoadPluginClass/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://2bab.me/">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>插件化笔记 #2 加载插件代码 | 2BAB&#39;s Blog</title>
  
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NFRNXW3SHS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NFRNXW3SHS');
</script>

<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/zh/">2BAB&#39;s Blog</a>
    </div>
    <h1>插件化笔记 #2 加载插件代码</h1>
    <div class="italic text-gray-500">
      2016/09/18
    </div>
    <div>
      <blockquote>
<p>Demo: <a href="https://github.com/2BAB/Android-Plugin-Dev-Notes">https://github.com/2BAB/Android-Plugin-Dev-Notes</a></p>
</blockquote>
<h2 id="%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E8%83%BD%E5%A4%9F%E8%A2%AB%E5%8A%A0%E8%BD%BD%E7%9A%84-.dex-%E6%96%87%E4%BB%B6" tabindex="-1">如何获取能够被加载的 .dex 文件</h2>
<p>准备如下两个测试类，其中TestDexInterface还需要拷贝一份到工程中</p>
<p><strong>[TestDexClass.java]</strong></p>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">example<span class="token punctuation">.</span>com<span class="token punctuation">.</span>classeasyload</span><span class="token punctuation">;</span><br><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestDexClass</span> <span class="token keyword">implements</span> <span class="token class-name">TestDexInterface</span><span class="token punctuation">{</span><br><br>    <span class="token annotation punctuation">@Override</span><br>    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getPiValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token number">3.14f</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br><span class="token punctuation">}</span></code></pre>
<p><strong>[TestDexInterface.java]</strong></p>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">example<span class="token punctuation">.</span>com<span class="token punctuation">.</span>classeasyload</span><span class="token punctuation">;</span><br><br><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TestDexInterface</span> <span class="token punctuation">{</span><br><br>    <span class="token keyword">float</span> <span class="token function">getPiValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token punctuation">}</span></code></pre>
<ol>
<li><code>javac *.java                              -&gt; .class</code></li>
<li><code>jar cvf origin.jar .                      -&gt; .jar</code></li>
<li><code>dx --dex --output=target.dex origin.jar   -&gt; .dex</code></li>
</ol>
<p>&lt;!--more--&gt;</p>
<p>按文章的步骤，自己实现了一遍，需要注意的是第二步打jar包的时候需要连包名所在的文件夹一起打进去</p>
<pre><code>|____example
| |____com
| | |____classeasyload
| | | |____TestDexClass.class
| | | |____TestDexInterface.class
</code></pre>
<p>jar包里应该是如上的结构。</p>
<h2 id="%E5%8A%A0%E8%BD%BD%E5%B9%B6%E8%B0%83%E7%94%A8.dex%E9%87%8C%E9%9D%A2%E7%9A%84%E6%96%B9%E6%B3%95" tabindex="-1">加载并调用.dex里面的方法</h2>
<p>这里我先 <code>adb shell mkdir -p /system/dex/</code>, 然后<code>adb push target.dex /system/dex/</code>
如MainActivity里代码所示：</p>
<pre class="language-java"><code class="language-java"><span class="token class-name">File</span> optimizedDexOutputPath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/system/dex/"</span> <span class="token operator">+</span> <span class="token string">"target.dex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 外部路径</span><br><span class="token class-name">File</span> dexOutputDir <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDir</span><span class="token punctuation">(</span><span class="token string">"dex"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 无法直接从外部路径加载.dex文件，需要指定APP内部路径作为缓存目录（.dex文件会被解压到此目录）</span><br><span class="token class-name">DexClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span><br>       optimizedDexOutputPath<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>       dexOutputDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>       <span class="token keyword">null</span><span class="token punctuation">,</span><br>       <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token class-name">Class</span> libProviderClazz <span class="token operator">=</span> dexClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"example.com.classeasyload.TestDexClass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name">TestDexInterface</span> dexInterface <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TestDexInterface</span><span class="token punctuation">)</span> libProviderClazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> dexInterface<span class="token punctuation">.</span><span class="token function">getPiValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token constant">LENGTH_LONG</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>最终成功Toast出了<code>3.14</code>。</p>
<h2 id="%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" tabindex="-1">参考资料</h2>
<p>本系列为笔记文，文中有大量的源码解析都是引用的其他作者的成果，详见下方参考资料。</p>
<ul>
<li><a href="http://blog.csdn.net/singwhatiwanna/article/details/40283117">http://blog.csdn.net/singwhatiwanna/article/details/40283117</a></li>
<li><a href="http://blog.csdn.net/NUPTboyZHB/article/category/1204147">http://blog.csdn.net/NUPTboyZHB/article/category/1204147</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/20515113">https://zhuanlan.zhihu.com/p/20515113</a></li>
</ul>
<p><em>欢迎关注我的<a href="/about">公众号和微博</a>。</em></p>

    </div>
    <hr />
      <div class="text-sm text-center">
        评论和交流请发送邮件到 xx2bab@gmail.com
      </div>
      <hr />
     <div class="text-center">
  <img class="w-64 inline-block" src="https://s2.loli.net/2023/05/13/FKYi5STEtmNZd8W.jpg" alt="Wechat Donate QACode" />
  <div class="text-sm">
    通过微信扫描赞赏码赞助此文
  </div>
</div> 
    <footer class="text-sm py-12 text-gray-500 text-center">
  
  <p><a href="/">ENG</a> / <a href="/zh">中文</a></p>
  
  2BAB's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>