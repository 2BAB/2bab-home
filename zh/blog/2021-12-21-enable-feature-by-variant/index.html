<html lang="zh" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="构建指北 #12 根据 Variant 决定是否启用插件" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://2bab.me/zh/blog/2021-12-21-enable-feature-by-variant/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://2bab.me/">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>构建指北 #12 根据 Variant 决定是否启用插件 | 2BAB&#39;s Blog</title>
  
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NFRNXW3SHS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NFRNXW3SHS');
</script>

<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/zh">2BAB&#39;s Blog</a>
    </div>
    <h1>构建指北 #12 根据 Variant 决定是否启用插件</h1>
    <div class="italic text-gray-500">
      2021/12/21
    </div>
    <div>
      <p>在 Android 开发中使用过第三方 Gradle 插件的同学都应该碰到过这个问题：<strong>我只想在某一些 buildType 或者 flavor 中应用这个插件，但是找不到合适的办法。</strong></p>
<p>这个问题的根本原因在于 Variant（buildType + flavor) 不是一个 Gradle 概念，而是源于 Android Gralde Plugin（AGP）的多渠道配置。所以从 Gradle 平台的角度很难向上提供便捷的支持：一个工程内的插件引入是全局的、平台性的，不以某一个插件的意志（AGP）而改变下层平台的机制。</p>
<p>OK，但我们的问题还是要解决的，所以便了有下面四种问题的解法（大雾。我们按照无效到高效的顺序一一解释其中的思路。</p>
<h2 id="%E6%A0%B9%E6%8D%AE-variant-%E5%8E%BB-apply-%E6%8F%92%E4%BB%B6%EF%BC%88%E6%97%A0%E6%95%88-x" tabindex="-1">根据 Variant 去 apply 插件（无效 X</h2>
<pre class="language-kotlin"><code class="language-kotlin">flavorDimensions <span class="token operator">+=</span> <span class="token string-literal singleline"><span class="token string">"server"</span></span><br>productFlavors <span class="token punctuation">{</span><br>    <span class="token operator">..</span><span class="token punctuation">.</span><br>    <span class="token function">create</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"production"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        dimension <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"server"</span></span><br>        applicationIdSuffix <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">".production"</span></span><br>        versionNameSuffix <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"-production"</span></span><br>        versionCode <span class="token operator">=</span> <span class="token number">2</span><br>        <span class="token function">apply</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"xxx"</span></span><span class="token punctuation">)</span> <span class="token comment">// 无效</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>很多 Android 或者 Gradle 的初学者会觉得，我把 <code>apply(...)</code> 放在这里不就好了？（当然，你肯定不能用 <code>plugins { id(&quot;xxx&quot;) }</code>）这里的误区在于，<strong><code>apply(...)</code> 方法和当前上下文对象并没有关联</strong>：</p>
<p><img src="https://2bab-images.lastmayday.com/20211221205845.png?imageslim" alt=""></p>
<p><img src="https://2bab-images.lastmayday.com/20211221210042.png?imageslim" alt=""></p>
<ul>
<li><code>create(&quot;...&quot;){}</code> 的闭包上下文是 <code>this:ApplicationProductFlavor</code>。</li>
<li><code>apply(...)</code> 则为挂载于 PluginAware 的一个扩展方法（以 <code>build.gradle.kts</code>），作用于整个 Project，这样一来你的插件还是会被全局引入。</li>
</ul>
<p>同样的经典误区：</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token function">create</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"production"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    dimension <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"server"</span></span><br>    applicationIdSuffix <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">".production"</span></span><br>    versionNameSuffix <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"-production"</span></span><br>    versionCode <span class="token operator">=</span> <span class="token number">2</span><br>    packagingOptions <span class="token punctuation">{</span><br>        jniLibs <span class="token punctuation">{</span><br>            excludes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"..."</span></span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><img src="https://2bab-images.lastmayday.com/20211221212514.png?imageslim" alt="">
你可能觉得这样可以为这个 flavor 设置单独的 <code>packageingOptions</code>，但实际上这个方法是 <code>CommonExtension</code> 接口的一个方法，并不属于 <code>ApplicationProductFlavor</code>。也即它是为整个 Android Gradle Plugin 进行设置，而不是单一 flavor，如果你在每个 flavor 中都进行不同的设置，最后一次的设置会覆盖前面所有的。针对这个问题的解决方法，可参考我之前 <a href="https://www.bilibili.com/video/BV1WP4y1G71h">GDG 分享</a>中的“二次配置”部分。</p>
<h2 id="%E6%A0%B9%E6%8D%AE%E5%91%BD%E4%BB%A4%E5%8E%BB-apply-%E6%8F%92%E4%BB%B6%EF%BC%88%E9%83%A8%E5%88%86%E6%9C%89%E6%95%88-x" tabindex="-1">根据命令去 apply 插件（部分有效 X</h2>
<p>我们本次讨论的问题在一些 StackOverflow 问答中也能查到，其中有大量的答案是关于“解析键入的命令”来进行判断。</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">if</span> <span class="token punctuation">(</span>gradle<span class="token punctuation">.</span>startParameter<span class="token punctuation">.</span>taskRequests<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"production"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>这种做法能够解决你输入的命令为 <code>./gradlew clean assembleProductionRelease</code> 等等的情况，因为这类命令中仅包含了一个 Variant 的信息（也就是 Production + Release）。然而如果输入的命令是 <code>./gradlew clean assembleRelease</code>，它同时打包 <code>Staging</code> 和 <code>Production</code> 两个 flavors，这时上面的 <code>if(...)</code> 条件就完全不成立，你的构建也会因此遭到破坏。</p>
<p>多数情况 <code>taskRequests</code> 下对第三方 Android 构建插件的开发者都是不应去获取和使用的，和第一条误区一样它是 Gradle 平台自身的 API，没有为上层 AGP 的 Variant 概念做优化。</p>
<h2 id="%E7%A6%81%E7%94%A8%E5%AF%B9%E5%BA%94-variant-%E7%9A%84%E6%8F%92%E4%BB%B6-task%EF%BC%88%E6%9C%89%E6%95%88-y" tabindex="-1">禁用对应 Variant 的插件 Task（有效 Y</h2>
<p>当然，SO 上也有人提到了正确、有效、且通用的做法——<strong>不要动态禁用（或开启）插件，而是去禁用插件内的 Task。</strong></p>
<pre class="language-kotlin"><code class="language-kotlin">plugins <span class="token punctuation">{</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.example.ua"</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br><span class="token comment">// or apply("com.example.ua")</span><br><span class="token operator">..</span><span class="token punctuation">.</span><br>tasks<span class="token punctuation">.</span><span class="token function">whenTaskAdded</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"production"</span></span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><br>            <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"release"</span></span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><br>            <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"UploadArchive"</span></span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        enabled <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>假设有一个上传构建结果的插件叫做 <code>com.example.ua</code>，我们不管什么情况，都在<code>build.gradle.kts</code> 内引用它。但是往下看，我们基于 <code>whenTaskAdded {...}</code> 做了类似上一条误区的 <code>if(...)</code> 判断，然后符合条件的 task 的 <code>enabled</code> 属性设置为 <code>false</code>。为什么上一个方法不行，而这个可以？</p>
<p>我们要复习下这条 Gradle 脚本和 <code>android{}</code> DSL 规则：不管你 shell 键入的命令是什么，你键入的是 <code>clean</code> 也好 <code>help</code> 也好，这份脚本都是会完整地被执行，所有 Variant 的 Task 都会被注册（当然现在通常都是惰性注册了 <code>register(...)</code> 而不用 <code>create()</code>）。<strong>而 <code>whenTaskAdded{...}</code> 是 Gradle 平台的 API，它才不管你上层注册的 Task 分不分 Variant，它只管把所有注册后且确定会添加进运行图（是个有向无环图 DAG）的 Task 在这里提供一个回调的时机给开发者。与此同时，几乎所有的 Android 生态协同插件都会基于 Variant 的名字去给自己 Task 命名（如果它需要是一个 VariantAware Task 的话），例如 “UploadArchiveWithLogForProductionRelease”。这个不成文的规则给了我们字符串匹配的机会，也即你看到的上述代码。</strong></p>
<p>对于插件怎么找到对应的所有 Task，目前没有自动化的办法，也没有 API（但是最近的一个 AGP Team Q&amp;A 上，他们提到在和 Gradle 推进这个功能）。你可以做的就是：<strong>引入插件前打印下 Task List，引入后再打印一遍，找二者的 Diff。</strong> 当然对于一些比较简单的插件，直接看下文档或者源码，整理下有哪几个 Task 也行。</p>
<p>所以这个方案小结下就一句话：总是引用插件，但禁用掉不需要的 Task。</p>
<h2 id="%E5%9C%A8-task-%E6%B3%A8%E5%86%8C%E6%97%B6%E6%8B%A6%E6%88%AA%EF%BC%88%E9%AB%98%E6%95%88-y" tabindex="-1">在 Task 注册时拦截（高效 Y</h2>
<p>我在上一篇[《构建指北 #11 BundleTool Gradle Plugin》](<a href="https://2bab.me/2021/12/19/bundle-tool-plugin">https://2bab.me/2021/12/19/bundle-tool-plugin</a>]中提到：</p>
<blockquote>
<p>bundle-tool-gradle-plugin 支持按不同 variant 渠道去开启插件的几个功能特性。</p>
</blockquote>
<p>这光听起来就和上一个方案就有点神似了，难不成就是把 <code>enabled = false</code> 藏 Plugin 里，再吐个 DSL 的开关配置出来给用户选择？其实不然，解决思路上已经大差不差了。但稍微思考下还有两个可以改进的空间：</p>
<ol>
<li>既然我们想要在插件内部控制开关，何必使用 <code>task.enabled = false</code>，<strong>直接把注册流程跳过就好了</strong>（当然，这个做法不适用于所有情况，有时候还是需要动态禁用的）。</li>
<li>对于大部分的 Android 生态协同插件，其 DSL 一般都是 Variant 无关的静态配置，如果要设计一个 Variant 有关的配置，可能只能传入一堆自定义 rules（如下代码）：</li>
</ol>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// 静态的 DSL 配置</span><br>bundletool <span class="token punctuation">{</span><br>    enableByVariantRules <span class="token punctuation">{</span><br>        <span class="token function">create</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"debugStaging"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            enabledFeature1 <span class="token operator">=</span> <span class="token boolean">true</span><br>            enabledFeature2 <span class="token operator">=</span> <span class="token boolean">true</span><br>            enabledFeature3 <span class="token operator">=</span> <span class="token boolean">false</span><br>        <span class="token punctuation">}</span><br>        <span class="token function">create</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"debugProduction"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token operator">..</span><span class="token punctuation">.</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span> </code></pre>
<p>这种 rules 的复杂度比较难控制，在上述代码里它是一个 2 * 2 * 3 的笛卡尔积，配置起来十分不变。解决的方法也很容易想到，<strong>如果它能做成传入一个 Kotlin Lambda（或者 Groovy Closure），不就很方便了？就像我们做二次配置时使用的 <code>onVariants(...) {...}</code> 方法一样，我们需要一些“动态”的东西，用户可以与之互动的东西，减少配置的复杂度。</strong></p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// “动态”的 DSL 配置，基于 Kotlin Lambda 和 Groovy Closure </span><br>bundleTool <span class="token punctuation">{</span><br>    enableByVariant <span class="token punctuation">{</span> variant<span class="token punctuation">,</span> feature <span class="token operator">-></span><br>        <span class="token operator">!</span><span class="token punctuation">(</span>variant<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"debug"</span></span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> feature <span class="token operator">==</span> BundleToolFeature<span class="token punctuation">.</span>GET_SIZE<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    <span class="token operator">..</span><span class="token punctuation">.</span><br><span class="token punctuation">}</span> </code></pre>
<p>其中 <code>variant</code> 参数是 <code>com.android.build.api.variant.Variant</code>，即我们平时使用的 Variant API v2 的 Variant 对象；<code>feature</code> 参数是一个自定义的 enum 类，方便每个插件定制。然后我们看下实现：</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">/**<br> * Extract `enableByVariant(...)` function, can be reused in other plugins.<br> * Currently the Lambda and Closure are defined by raw types, they can be encapsulated<br> * by [Property] as well to fulfill "lazily produced/consumed" purpose.<br> */</span><br><span class="token keyword">abstract</span> <span class="token keyword">class</span> EnableByFeatureExtension<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span><br><br>    <span class="token keyword">var</span> kotlinEnableByVariant<span class="token operator">:</span> EnableByVariant<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><br><br>    <span class="token keyword">var</span> groovyEnableByVariant<span class="token operator">:</span> Closure<span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><br><br>    <span class="token comment">// For Gradle Kotlin DSL</span><br>    <span class="token keyword">fun</span> <span class="token function">enableByVariant</span><span class="token punctuation">(</span>selector<span class="token operator">:</span> EnableByVariant<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        kotlinEnableByVariant <span class="token operator">=</span> selector<br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// For Gradle Groovy DSL</span><br>    <span class="token keyword">fun</span> <span class="token function">enableByVariant</span><span class="token punctuation">(</span>selector<span class="token operator">:</span> Closure<span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        groovyEnableByVariant <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">dehydrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">isFeatureEnabled</span><span class="token punctuation">(</span>variant<span class="token operator">:</span> Variant<span class="token punctuation">,</span> t<span class="token operator">:</span> T<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">{</span><br>        kotlinEnableByVariant <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            kotlinEnableByVariant<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>variant<span class="token punctuation">,</span> t<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        groovyEnableByVariant <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            groovyEnableByVariant<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>variant<span class="token punctuation">,</span> t<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token boolean">false</span><br>    <span class="token punctuation">}</span><br><br><span class="token punctuation">}</span><br><br><span class="token keyword">internal</span> <span class="token keyword">typealias</span> EnableByVariant<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span>variant<span class="token operator">:</span> Variant<span class="token punctuation">,</span> t<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token operator">-></span> Boolean<br><br><span class="token keyword">abstract</span> <span class="token keyword">class</span> BundleToolExtension<span class="token operator">:</span> EnableByFeatureExtension<span class="token operator">&lt;</span>BundleToolFeature<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token keyword">abstract</span> <span class="token keyword">val</span> buildApks<span class="token operator">:</span> NamedDomainObjectContainer<span class="token operator">&lt;</span>BuildApksRule<span class="token operator">></span><br><br>    <span class="token keyword">abstract</span> <span class="token keyword">val</span> getSize<span class="token operator">:</span> NamedDomainObjectContainer<span class="token operator">&lt;</span>GetSizeRule<span class="token operator">></span><br><br><span class="token punctuation">}</span><br><br><span class="token keyword">enum</span> <span class="token keyword">class</span> BundleToolFeature <span class="token punctuation">{</span><br><br>    <span class="token comment">// It's currently a predecessor for GET_SIZE,</span><br>    <span class="token comment">// and the first job that plugin does,</span><br>    <span class="token comment">// disable it will cause the task registry got removed.</span><br>    <span class="token comment">// The work action that transforms .aab to .apks using `build-apks` command.</span><br>    BUILD_APKS<span class="token punctuation">,</span><br><br>    <span class="token comment">// The work action that gets the transformed .apks file size using `get-size total` command.</span><br>    GET_SIZE<br><br><span class="token punctuation">}</span></code></pre>
<p>这里我们分别定义了针对 Groovy 和 Kotlin 两种 Gradle DSL 的 Closure/Lambda，它们接受 <code>Variant</code> 和自定义的一个泛型参数，返回一个 Boolean 值表示是否开启对应功能。接着我们定义了 <code>isFeatureEnabled(..,): Boolean</code> 方法对两个语言分支进行整合，方便插件内部的调用。当实际使用该 <code>EnableByFeatureExtension</code> 时，实际上我们会让插件的 <code>BundleToolExtension</code> 继承于它，从而隔离出插件本体功能和通用的开关特性，任意其他的插件可以方便地拷走这个类加入到自己的 Extension 中。</p>
<pre class="language-kotlin"><code class="language-kotlin">androidExtension<span class="token punctuation">.</span><span class="token function">onVariants</span> <span class="token punctuation">{</span> variant <span class="token operator">-></span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">isFeatureEnabled</span><span class="token punctuation">(</span>variant<span class="token punctuation">,</span> BundleToolFeature<span class="token punctuation">.</span>BUILD_APKS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span><span class="token label symbol">@onVariants</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">val</span> featureGetSize <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">isFeatureEnabled</span><span class="token punctuation">(</span>variant<span class="token punctuation">,</span> BundleToolFeature<span class="token punctuation">.</span>GET_SIZE<span class="token punctuation">)</span><br>    <span class="token operator">..</span><span class="token punctuation">.</span><br>    <span class="token keyword">val</span> buildApksTaskProvider <span class="token operator">=</span> project<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>register<span class="token operator">&lt;</span>BundleToolTask<span class="token operator">></span><span class="token punctuation">(</span><br>        <span class="token string-literal singleline"><span class="token string">"TransformApksFromBundleFor</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">variantName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><br>    <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        enableGetSizeFeature <span class="token operator">=</span> featureGetSize<br>        <span class="token operator">..</span><span class="token punctuation">.</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">abstract</span> <span class="token keyword">class</span> BundleToolTask <span class="token operator">:</span> <span class="token function">DefaultTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token annotation builtin">@get:Input</span><br>    <span class="token keyword">var</span> enableGetSizeFeature<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token operator">..</span><span class="token punctuation">.</span><br>    <br>    <span class="token annotation builtin">@TaskAction</span><br>    <span class="token keyword">fun</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token operator">..</span><span class="token punctuation">.</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableGetSizeFeature<span class="token punctuation">)</span> <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>最后，我们展示了在两个地方使用这个开关的例子：</p>
<ol>
<li>如果某个 Feature 影响的是整个 Task，我们可以使用开关跳过它的注册。</li>
<li>如果某个 Feature 只影响了一个 Task 内的部分功能，我们将开关的值传入 Task 内部再进行判断。</li>
</ol>
<p>上述的流程并非完全不可变，这个思路可以结合其他的开关方式进行调整。目前我已经在 <a href="https://github.com/2BAB/bundle-tool-gradle-plugin">bundle-tool-gradle-plugin</a> 和 <a href="https://github.com/2BAB/ScratchPaper">ScratchPaper</a> 使用了这个方案，让插件功能的引入更加灵活。</p>
<p><strong>当然，你可能也已经发现，这个方案其实是从插件开发的角度入手，除非所有的插件开发者都使用了类似的方案进行优化，否则方案 3 仍然是从用户角度出发的目前唯一的通用办法。但是这个方案的优势在于控制粒度更精细、也更方便，开发者可以任意定制。</strong></p>
<h2 id="%E6%80%BB%E7%BB%93" tabindex="-1">总结</h2>
<p>本文主要讨论了插件功能根据不同 Variant 渠道进行开启的解决方案，可能也是全网第一次有如此详细和完整的多种方案对比讨论。文章的思考和方案其实还可以被运用到其他的一些 Gradle 场景中，大家可以自行发挥想象。那 2021 年的最后一篇技术文章就到这边啦，咱们明年再见。</p>
<p><em>欢迎关注我的<a href="/about"> Github / 公众号 / 播客 / 微博 / Twitter</a>。</em></p>

    </div>
    <hr />
      <div class="text-sm text-center">
        评论和交流请发送邮件到 xx2bab@gmail.com
      </div>
      <hr />
     <div class="text-center">
  <img class="w-64 inline-block" src="https://s2.loli.net/2023/05/13/FKYi5STEtmNZd8W.jpg" alt="Wechat Donate QACode" />
  <div class="text-sm">
    通过微信扫描赞赏码赞助此文
  </div>
</div> 
    <footer class="text-sm py-12 text-gray-500 text-center">
  
  <p><a href="/">ENG</a> / <a href="/zh">中文</a></p>
  
  2BAB's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>