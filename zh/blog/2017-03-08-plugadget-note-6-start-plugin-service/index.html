<html lang="zh" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="插件化笔记 #6 启动插件 Service" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://2bab.me/zh/blog/2017-03-08-plugadget-note-6-start-plugin-service/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://2bab.me/">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>插件化笔记 #6 启动插件 Service | 2BAB&#39;s Blog</title>
  
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NFRNXW3SHS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NFRNXW3SHS');
</script>

<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/zh/">2BAB&#39;s Blog</a>
    </div>
    <h1>插件化笔记 #6 启动插件 Service</h1>
    <div class="italic text-gray-500">
      2017/03/08
    </div>
    <div>
      <blockquote>
<p>Demo: <a href="https://github.com/2BAB/Android-Plugin-Dev-Notes">https://github.com/2BAB/Android-Plugin-Dev-Notes</a></p>
</blockquote>
<p>上节学习到了插件化资源 ID 冲突的问题和解法，本节主要讨论 Service 的插件化启动。按照本系列的尿性，肯定要简单易搞，所以预注册 Service 是本节的讨论前提。具体原因在 Activity 那节写了，但是需要额外说明的是其实 Service 由于量少且新增少，是比较少做<a href="http://weishu.me/2016/05/11/understand-plugin-framework-service/">复杂插件化</a>方案的。</p>
<p>&lt;!--more--&gt;</p>
<h2 id="service-%E7%9A%84%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B" tabindex="-1">Service 的启动流程</h2>
<p>推荐看这篇 <a href="http://gityuan.com/2016/03/06/start-service/">startService启动过程分析</a>：</p>
<p><img src="http://2bab-images.lastmayday.com/blog/2017-03-08-start-plugin-service-1.jpeg?imageslim" alt=""></p>
<p><img src="http://2bab-images.lastmayday.com/blog/2017-03-08-start-plugin-service-2.jpeg?imageslim" alt=""></p>
<p>其实由于我们提前注册了 Service，没有了各种校验问题，所以只需要跟 Activity 一样注入 ClassLoader 去加载对应的模块代码就可以启动 Service。但是 Service 并没有像 Activity 那样方便的切入点（Instrumention）：</p>
<p>[ActivityThread.java]</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCreateService</span><span class="token punctuation">(</span><span class="token class-name">CreateServiceData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// If we are getting ready to gc after going to the background, well</span><br>    <span class="token comment">// we are back active so skip it.</span><br>    <span class="token function">unscheduleGcIdler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">LoadedApk</span> packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span><br>                data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        service <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Service</span><span class="token punctuation">)</span> cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unable to instantiate service "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">LoadedApk</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span><span class="token class-name">ApplicationInfo</span> ai<span class="token punctuation">,</span> <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>ai<span class="token punctuation">,</span> compatInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><br><span class="token keyword">private</span> <span class="token class-name">LoadedApk</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token class-name">ApplicationInfo</span> aInfo<span class="token punctuation">,</span> <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">,</span> <br>        <span class="token class-name">ClassLoader</span> baseLoader<span class="token punctuation">,</span> <span class="token keyword">boolean</span> securityViolation<span class="token punctuation">,</span> <span class="token keyword">boolean</span> includeCode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> registerPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> differentUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk</span><span class="token punctuation">></span></span> ref<span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>differentUser<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token comment">// Caching not supported across users</span><br>            ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>includeCode<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            ref <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            ref <span class="token operator">=</span> mResourcePackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <br>        <span class="token class-name">LoadedApk</span> packageInfo <span class="token operator">=</span> ref <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span>mResources <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>packageInfo<span class="token punctuation">.</span>mResources<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUpToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>includeCode <span class="token operator">?</span> <span class="token string">"Loading code package "</span><br>                        <span class="token operator">:</span> <span class="token string">"Loading resource-only package "</span><span class="token punctuation">)</span> <span class="token operator">+</span> aInfo<span class="token punctuation">.</span>packageName<br>                        <span class="token operator">+</span> <span class="token string">" (in "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>mBoundApplication <span class="token operator">!=</span> <span class="token keyword">null</span><br>                                <span class="token operator">?</span> mBoundApplication<span class="token punctuation">.</span>processName <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><br>                        <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            packageInfo <span class="token operator">=</span><br>                    <span class="token keyword">new</span> <span class="token class-name">LoadedApk</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> compatInfo<span class="token punctuation">,</span> baseLoader<span class="token punctuation">,</span><br>                            securityViolation<span class="token punctuation">,</span> includeCode <span class="token operator">&amp;&amp;</span><br>                            <span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_HAS_CODE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> registerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSystemThread <span class="token operator">&amp;&amp;</span> <span class="token string">"android"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    packageInfo<span class="token punctuation">.</span><span class="token function">installSystemApplicationInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">,</span><br>                            <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>differentUser<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token comment">// Caching not supported across users</span><br>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>includeCode<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                mPackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span><br>                        <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                mResourcePackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span><br>                        <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">return</span> packageInfo<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>既然没有直接有效的切入点，那么其他的插件化方案都是怎么做的？除了文初 weishu 的那个高级方法以外，还有一种比较实在并且通吃的解法。</p>
<h2 id="%E5%8A%A8%E6%80%81%E6%8F%92%E5%85%A5-element---dex-%E5%8A%A8%E6%80%81%E6%80%A7%E7%9A%84%E9%80%9A%E8%A7%A3" tabindex="-1">动态插入 Element - Dex 动态性的通解</h2>
<p>Dex 动态载入的原理其实是从 Google MultiDex 方案出来后大家才敢投入研究和使用的，具体参考<a href="http://souly.cn/%E6%8A%80%E6%9C%AF%E5%8D%9A%E6%96%87/2016/02/25/android%E5%88%86%E5%8C%85%E5%8E%9F%E7%90%86/">Android分包原理</a>这篇文章。</p>
<p>在了解了有这样的方案之后，很多人纷纷表示这可以用来做插件化和热修复，类似的博客有大头鬼的<a href="http://blog.csdn.net/lzyzsd/article/details/49843581">Android热更新实现原理</a>。</p>
<p>看完这两篇之后，其实应该了解的差不多了。<strong>本质上这种 Dex 载入的方案就是把代码载入到自定义的 ClassLoader 中，跟之前写的 Activity Hook 方案异曲同工。只不过这是一种比较彻底、方便，一次性解决了所有需要注入 ClassLoader 的地方。不仅可以用来启动 Service，也可以用来启动 Activity（当然前提是你预注册了）。</strong></p>
<p>具体代码 Demo 请参考文初的链接。</p>
<h2 id="demo-usage" tabindex="-1">Demo Usage</h2>
<ol>
<li>在插件工程 <code>./gradlew assembleDebug</code> 打出插件</li>
<li>导入插件到手机指定目录（这个目录是自己随便指定的，跟 Demo 代码里的加载路径一致即可）：<code>mv app/build/outputs/apk/app-debug.apk app/build/outputs/apk/6-Plugin.apk &amp;&amp; adb push app/build/outputs/apk/6-Plugin.apk /system/dex/</code></li>
<li>在宿主工程 <code>./gradlew installDebug</code> 打包并安装宿主 APK</li>
<li>打开宿主 App，查看效果</li>
<li><img src="http://2bab-images.lastmayday.com/blog/2017-03-08-start-plugin-service-3.png?imageslim" alt=""></li>
</ol>
<h2 id="%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" tabindex="-1">参考资料</h2>
<p>本系列为笔记文，文中有大量的源码解析都是引用的其他作者的成果，本文参考资料均已在文中给出链接。</p>
<p><em>欢迎关注我的<a href="/about">公众号和微博</a>。</em></p>

    </div>
    <hr />
      <div class="text-sm text-center">
        评论和交流请发送邮件到 xx2bab@gmail.com
      </div>
      <hr />
     <div class="text-center">
  <img class="w-64 inline-block" src="https://s2.loli.net/2023/05/13/FKYi5STEtmNZd8W.jpg" alt="Wechat Donate QACode" />
  <div class="text-sm">
    通过微信扫描赞赏码赞助此文
  </div>
</div> 
    <footer class="text-sm py-12 text-gray-500 text-center">
  
  <p><a href="/en">ENG</a> / <a href="/zh">中文</a></p>
  
  2BAB's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>