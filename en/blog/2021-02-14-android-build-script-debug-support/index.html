<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="Build Guide #9 Debugging Gradle Scripts" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://2bab.me/en/blog/2021-02-14-android-build-script-debug-support/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://2bab.me/">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>Build Guide #9 Debugging Gradle Scripts | 2BAB&#39;s Blog</title>
  
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NFRNXW3SHS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NFRNXW3SHS');
</script>

<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/">2BAB&#39;s Blog</a>
    </div>
    <h1>Build Guide #9 Debugging Gradle Scripts</h1>
    <div class="italic text-gray-500">
      2021/02/14
    </div>
    <div>
      <p><em>&quot;Build Guide&quot; is a series of articles exploring Android build-related topics, covering Gradle, Android Gradle Plugin, Kotlin Script, and other tools, as well as their architectural applications. Starting from problem discovery and resolution, and landing on sharing new knowledge to improve productivity.</em></p>
<p>This article discusses the current debugging support for <code>*.gradle.kts</code> scripts in IDEA / Android Studio.</p>
<h2 id="debugging-capabilities" tabindex="-1">Debugging Capabilities</h2>
<p>Regarding the definition of debugging capabilities, let me give an example. We add various script snippets to a common <code>build.gradle.kts</code>, including but not limited to property declarations, file reading, Gradle API operations, AGP API operations, etc., then set multiple breakpoints. When compiling, we remote attach to check <strong>whether it can suspend at the correct location, whether it can get context information, and whether it can perform Expression Evaluate operations</strong>.</p>
<p>Specific test points:</p>
<ol>
<li>Context information inside the <code>android { default { ... } }</code> closure;</li>
<li>Context information inside the <code>dependencies { ... }</code> closure;</li>
<li>A small custom script snippet in <code>build.gradle.kts</code>, containing property definitions, Gradle API calls, AGP API calls - context information at these three points;</li>
<li>A small custom script snippet in <code>prebuilt.gradle.kts</code> inside <code>/buildSrc</code>, also containing the same three points;</li>
<li>A custom plugin inside <code>/buildSrc</code> - context information when running the plugin's apply method (as a reference for complete debugging capability).</li>
</ol>
<p>I conducted two experiments. The first was about half a year ago using Android Studio 4.0 + IDEA 2020.1, and the second was recently using Android Studio 4.2.0-beta04 + IDEA 2021.1.EAP. The test results below all use the second IDE version plus:</p>
<ul>
<li>Android Gradle Plugin 4.1.1</li>
<li>Kotlin 1.4.30</li>
<li>Gradle 6.8.2</li>
</ul>
<p>Here we focus on Kotlin DSL; the Groovy DSL situation can be analyzed similarly.</p>
<h2 id="multi-module-android-project" tabindex="-1">Multi-module Android Project</h2>
<p>For the first test, we used a multi-module (and multi-Application) project, with the following results:</p>
<table>
<thead>
<tr>
<th style="text-align:center">#</th>
<th style="text-align:center">Test Item</th>
<th style="text-align:center">IDEA &amp; Android Studio</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center"><code>android { default { ... } }</code></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center"><code>dependencies { ... }</code></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center"><code>build.gradle.kts</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">3.1</td>
<td style="text-align:center"></td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">3.2</td>
<td style="text-align:center"></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">3.3</td>
<td style="text-align:center"></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center"><code>prebuilt.gradle.kts</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">4.1</td>
<td style="text-align:center"></td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">4.2</td>
<td style="text-align:center"></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">4.3</td>
<td style="text-align:center"></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">plugin</td>
<td style="text-align:center">Y</td>
</tr>
</tbody>
</table>
<p><img src="https://2bab-images.lastmayday.com/blog/Screenshot%202021-02-15%20at%2010.30.01%20AM.png?imageslim" alt=""></p>
<p>Quick summary:</p>
<ul>
<li>The results from both IDEs are completely consistent (not surprising even though AS is the community edition);</li>
<li>Breakpoints at 3.1 and 4.1 can be correctly recognized but cannot get context information;</li>
<li><strong>When debugging breakpoints in <code>build.gradle.kts</code>, you must manually specify which script the current source corresponds to, as shown in the dropdown menu in the image above; the basis for judgment is the context information provided by the <code>this</code> object in the Variables section of the current debug panel. For example, here <code>this</code> points to DefaultConfig, and we only set breakpoints on the defaultConfig of the app module across multiple scripts, so we select <code>app</code></strong>;</li>
<li><strong>In this test, Gradle script debugging support is still not comprehensive enough.</strong></li>
</ul>
<h2 id="single-module-kotlin-project" tabindex="-1">Single-module Kotlin Project</h2>
<p>Next, let's test a simple Kotlin project:</p>
<table>
<thead>
<tr>
<th style="text-align:center">#</th>
<th style="text-align:center">Test Item</th>
<th style="text-align:center">IDEA &amp; Android Studio</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center"><code>java { ... }</code></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center"><code>dependencies { ... }</code></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center"><code>build.gradle.kts</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">3.1</td>
<td style="text-align:center"></td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">3.2</td>
<td style="text-align:center"></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">3.3</td>
<td style="text-align:center"></td>
<td style="text-align:center">N/A</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center"><code>prebuilt.gradle.kts</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">4.1</td>
<td style="text-align:center"></td>
<td style="text-align:center">N</td>
</tr>
<tr>
<td style="text-align:center">4.2</td>
<td style="text-align:center"></td>
<td style="text-align:center">Y</td>
</tr>
<tr>
<td style="text-align:center">4.3</td>
<td style="text-align:center"></td>
<td style="text-align:center">N/A</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">plugin</td>
<td style="text-align:center">Y</td>
</tr>
</tbody>
</table>
<p>The results are no different from the previous multi-module Android project.</p>
<h2 id="common-debugging-issues" tabindex="-1">Common Debugging Issues</h2>
<p>Here are some common issues for reference:</p>
<h3 id="breakpoint-line-jumping" tabindex="-1">Breakpoint Line Jumping</h3>
<p>When dealing with some simple requirements, such as modifying generated APK names, we often write and debug scripts directly in <code>build.gradle.kts</code>. <strong>During debugging, although breakpoints appear to be set in AS or IDEA, various situations occur during execution where the source code cannot be matched, causing line jumping. In this case, you need to manually specify the corresponding script using the method mentioned in the summary above.</strong></p>
<h3 id="idea-support-for-android-plugin" tabindex="-1">IDEA Support for Android Plugin</h3>
<p>Note that IDEA generally supports new features faster, but support for Android Gradle Plugin lags behind Android Studio. For example, after the current 4.1.1 version of Android Studio was released, IDEA announced support for 4.1 in 2020.3.2 (but actual testing shows it doesn't support 4.1.1; the <a href="https://youtrack.jetbrains.com/issue/IDEA-252775">issue</a> says 2021.1.EAP actually supports it).</p>
<h3 id="using-plugin-wrapping" tabindex="-1">Using Plugin Wrapping</h3>
<p>In the early days based on Groovy DSL + <code>build.gradle</code> scripts (around AGP 2.x era), debugging support was even worse. But there was a workaround for the third test point above: wrap the custom script block in <code>build.gradle</code> into a Plugin. However, this is currently not viable in AS 4.2.0-beta04 or IDEA 2021.1.EAP testing. On the Kotlin DSL side, although the API documentation looks supportive, the plugin cannot actually be created, causing script compilation failure, making debugging moot. Here's a reference <a href="https://github.com/gradle/gradle/issues/13667">issue</a>.</p>
<p><img src="https://2bab-images.lastmayday.com/blog/Screenshot%202021-02-15%20at%204.54.37%20PM.png?imageslim" alt=""></p>
<h3 id="run-button-displayed-in-build.gradle(.kts)-in-ide" tabindex="-1">Run Button Displayed in build.gradle(.kts) in IDE</h3>
<p>Additionally, some colleagues may have seen a &quot;run button&quot; and &quot;menu&quot; like this in <code>build.gradle</code> + IDEA 2020.x environment, similar to running a unit test or a Java main method:</p>
<p><img src="https://2bab-images.lastmayday.com/blog/Screenshot%202020-07-03%20at%203.12.07%20PM.png?imageslim" alt=""></p>
<p>However, its principle should be consistent with manually executing Gradle Sync / Build, and it hasn't changed our test results.</p>
<h2 id="summary" tabindex="-1">Summary</h2>
<p>Gradle script (specifically <code>*.gradle.kts</code>, though <code>*.gradle</code> should be similar) debugging support is currently weak. Complex logic should use precompiled plugins/standalone plugins in <code>buildSrc</code>, which have complete debugging capabilities.</p>

    </div>
    <hr />
      <div class="text-sm text-center">
        For comments and further discussion, mail to xx2bab@gmail.com
      </div>
      <hr />
    
    <footer class="text-sm py-12 text-gray-500 text-center">
  
  <p><a href="/">ENG</a> / <a href="/zh">中文</a></p>
  
  2BAB's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>