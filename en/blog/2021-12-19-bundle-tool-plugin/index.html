<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="Build Guide #11 BundleTool Gradle Plugin" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://2bab.me/en/blog/2021-12-19-bundle-tool-plugin/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://2bab.me/">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>Build Guide #11 BundleTool Gradle Plugin | 2BAB&#39;s Blog</title>
  
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NFRNXW3SHS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NFRNXW3SHS');
</script>

<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/">2BAB&#39;s Blog</a>
    </div>
    <h1>Build Guide #11 BundleTool Gradle Plugin</h1>
    <div class="italic text-gray-500">
      2021/12/19
    </div>
    <div>
      <p>App Bundle (.aab) as the officially promoted new delivery format for Android has been around for a while. This year's PlayStore policy mandating that &quot;all new apps must use .aab&quot; for submission has become a major driver for everyone to make the switch. Making your app compatible with and packaging into .aab format is not complicated - simply add the corresponding DSL configuration and replace the packaging command with <code>bundle${VariantName}</code>. However, the .aab obtained after packaging cannot be directly installed on debugging devices using adb locally. You need to use <a href="https://github.com/google/bundletool">bundletool</a> to convert it to .apks before calling its install command to install.</p>
<h2 id="common-scenarios" tabindex="-1">Common Scenarios</h2>
<p>The <a href="https://developer.android.com/studio/command-line/bundletool#build_app_bundle">BundleTool official documentation</a> lists various uses of CLI commands. In more complex environments, you might have encountered these scenarios with BundleTool:</p>
<ol>
<li>During local testing, you need to manually run conversion and installation commands using BundleTool's CLI;</li>
<li>In CI environments, you need to configure the BundleTool CLI tool, then write some Shell scripts to control the post-packaging conversion process;</li>
<li>Real device labs, cloud device testing platforms need to integrate BundleTool into corresponding tests, making it convenient to generate apks packages for specific device models.</li>
</ol>
<p>These scenarios often come with the following issues:</p>
<ol>
<li>Some internal test package distribution channels don't support aab and apks. We need to do quick functional tests on these non-GP, non-real-device-lab platforms where universal apk is the best choice for such scenarios (but packaging a new apk from scratch is obviously a waste of resources);</li>
<li>After uploading the aab package to GP's Console, you can clearly see the estimated download size for all supported devices, but this data metric is not convenient to collect and quantify on CI using Shell scripts (though it might be possible with some effort or Python);</li>
<li>AGP actually integrates the BundleTool package, so having to configure BundleTool's CLI separately each time seems somewhat redundant.</li>
</ol>
<p>This made me wonder: AGP has BundleTool as a dependency - doesn't it have these subsequent BundleTool conversion Tasks? Wouldn't using Gradle for these subsequent operations actually be more suitable?</p>
<h2 id="deep-dive-into-agp-%26-bundletool" tabindex="-1">Deep Dive into AGP &amp; BundleTool</h2>
<p>If we open the IDE's Gradle Task list and search for the &quot;Bundle&quot; keyword, we'll easily find tasks like <code>makeApkFromBundleForXxxx</code> etc. Their implementation is the <code>com.android.build.gradle.internal.tasks.BundleToApkTask</code> class.</p>
<p><img src="https://2bab-images.lastmayday.com/20211219_bundle_tool_bundle_to_apk_task.png?imageslim" alt="Task list and BundleToApkTask screenshot"></p>
<p>When checking the associated usage of this class in the source code, you'll find that besides registration, there's no trace of this class being used anywhere else. And the specific role of this task itself is actually just:</p>
<ul>
<li>Depends on <code>PackageXxxBundle</code>, waiting for it to produce an unsigned Bundle;</li>
<li>Inputs the Bundle from the previous step, executes the <code>BuildApksCommand</code> command from the BundleTool package to produce an .apks package.</li>
<li>From its input parameters, you can see that the only <strong>configuration</strong> it actually exposes to users is <code>enableLocalTesting</code>, while everything else uses the <strong>default values</strong> of BundleTool's <code>build-apks</code> command;</li>
<li>From its output result (see below), you'll discover it's actually just an &quot;<strong>intermediate product</strong>&quot; (located in the <code>/intermediates</code> folder), not a final product.</li>
</ul>
<p><img src="https://2bab-images.lastmayday.com/20211219_bundle_tool_tasks_1.png?imageslim" alt=""></p>
<p>This is a bit like &quot;food that's tasteless but a pity to throw away&quot;: there's an existing Task but its usage scope is very limited. Why not... wrap our own Gradle Plugin using the BundleTool library?</p>
<h2 id="how-to-wrap-bundle-tool-gradle-plugin%3F" tabindex="-1">How to Wrap bundle-tool-gradle-plugin?</h2>
<p>After simple analysis of BundleTool's several commands, we found their dependency relationships as follows:</p>
<p><img src="https://2bab-images.lastmayday.com/20211219_bundle_tool_commands.png?imageslim" alt=""></p>
<p>Among them:</p>
<ul>
<li>In terms of sequence, <code>build-apks</code> is a required prerequisite task (solid line) for the other commands, and <code>get-device-spec</code> is an optional prerequisite task (dashed line) for several commands.</li>
<li>In terms of interaction, <code>build-apks</code> and <code>get-size</code> (italicized parts) are closely related to the build process and don't require test devices; other commands require test devices.</li>
<li><code>get-device-spec</code> exporting json files is a one-time task, we can assume this part is already complete;</li>
</ul>
<p>Thus, our <strong>involved domain</strong> is also clear: <code>build-apks</code> and <code>get-size</code> commands that are directly related to final products. <code>install-apks</code> and <code>extract-apks</code> can be completed locally using CLI based on the current device, and in CI or cloud testing platforms there are usually dedicated scripts to handle them in combination with BundleTool.</p>
<p>Then we consider <strong>how to get and modify the final output Bundle</strong>. The new Variant API actually already provides convenient methods to modify and get the final Bundle. The entire process can refer to the running screenshot below. You can see that compared to the previous intermediate product mode, Variant API products are all output to the <code>/outputs</code> folder now. Since we don't need the intermediate aab, we just need to simply call <code>variants.get(SingleArtifact.BUNDLE)</code>, pass the obtained .aab file to a custom Task, and then borrow from AGP's code to wrap various commands:</p>
<p><img src="https://2bab-images.lastmayday.com/20211219_bundle_tool_tasks_2.png?imageslim" alt=""></p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// A simple Task to verify the idea. The complete plugin implementation is more complex than this. Please refer to the repository link at the end</span><br><span class="token keyword">abstract</span> <span class="token keyword">class</span> ConsumeBundleFileTask <span class="token operator">:</span> <span class="token function">DefaultTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token annotation builtin">@get:InputFiles</span><br>    <span class="token keyword">abstract</span> <span class="token keyword">val</span> finalBundleProperty<span class="token operator">:</span> RegularFileProperty<br><br>    <span class="token annotation builtin">@get:Internal</span><br>    <span class="token keyword">abstract</span> <span class="token keyword">val</span> buildToolInfo<span class="token operator">:</span> Property<span class="token operator">&lt;</span>BuildToolInfo<span class="token operator">></span><br><br>    <span class="token annotation builtin">@get:Nested</span><br>    <span class="token keyword">lateinit</span> <span class="token keyword">var</span> signingConfigData<span class="token operator">:</span> SigningConfigDataProvider<br><br>    <span class="token annotation builtin">@get:OutputFile</span><br>    <span class="token keyword">abstract</span> <span class="token keyword">val</span> apksFileProperty<span class="token operator">:</span> RegularFileProperty<br><br>    <span class="token annotation builtin">@TaskAction</span><br>    <span class="token keyword">fun</span> <span class="token function">taskAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">val</span> aapt2Path <span class="token operator">=</span> buildToolInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span>BuildToolInfo<span class="token punctuation">.</span>PathId<span class="token punctuation">.</span>AAPT2<span class="token punctuation">)</span><br>        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">".get(SingleArtifact.BUNDLE)"</span></span><span class="token punctuation">)</span><br>        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"[ConsumeBundleFileTask][input]:"</span></span> <span class="token operator">+</span> finalBundleProperty<span class="token punctuation">.</span>asFile<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span><br>        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"[ConsumeBundleFileTask][output]:"</span></span> <span class="token operator">+</span> apksFileProperty<span class="token punctuation">.</span>asFile<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span><br>        <span class="token keyword">val</span> signingConfigData <span class="token operator">=</span> signingConfigData<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!!</span><br>        <span class="token keyword">val</span> command <span class="token operator">=</span> BuildApksCommand<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">setBundlePath</span><span class="token punctuation">(</span>finalBundleProperty<span class="token punctuation">.</span>asFile<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">setOutputFile</span><span class="token punctuation">(</span>apksFileProperty<span class="token punctuation">.</span>asFile<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">setAapt2Command</span><span class="token punctuation">(</span><br>                Aapt2Command<span class="token punctuation">.</span><span class="token function">createFromExecutablePath</span><span class="token punctuation">(</span><br>                    <span class="token function">File</span><span class="token punctuation">(</span>aapt2Path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">setSigningConfiguration2</span><span class="token punctuation">(</span><br>                keystoreFile <span class="token operator">=</span> signingConfigData<span class="token punctuation">.</span>storeFile<span class="token punctuation">,</span><br>                keystorePassword <span class="token operator">=</span> signingConfigData<span class="token punctuation">.</span>storePassword<span class="token punctuation">,</span><br>                keyAlias <span class="token operator">=</span> signingConfigData<span class="token punctuation">.</span>keyAlias<span class="token punctuation">,</span><br>                keyPassword <span class="token operator">=</span> signingConfigData<span class="token punctuation">.</span>keyPassword<br>            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLocalTestingMode</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><br>        command<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    <span class="token operator">..</span><span class="token punctuation">.</span><br><span class="token punctuation">}</span></code></pre>
<p>Friends unfamiliar with the <strong>new Variant API</strong> can refer to my sharing this month at GDG community &quot;Extend Android Build Process - Based on New Variant/Artifact APIs&quot; (<a href="https://www.bilibili.com/video/BV1WP4y1G71h?share_source=copy_web">replay</a>).</p>
<p>Finally, let's briefly look at BundleTool's BuildApksCommand.Builder. This Builder's setXxx-related <strong>APIs</strong> have only had two minor changes in the past year, one of which was a new method addition that doesn't really affect original compatibility - it's <strong>relatively stable</strong> compared to AGP.</p>
<p>At this point, the theoretical construction cost and maintenance cost of the entire plugin are within acceptable range.</p>
<h2 id="using-the-plugin" tabindex="-1">Using the Plugin</h2>
<p>The plugin development is no different from several others I've written before. Let's look directly at plugin usage.</p>
<p><strong>0x01. Add the plugin to classpath:</strong></p>
<pre class="language-kotlin"><code class="language-kotlin">buildscript <span class="token punctuation">{</span><br>    repositories <span class="token punctuation">{</span><br>        <span class="token operator">..</span><span class="token punctuation">.</span><br>        <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    dependencies <span class="token punctuation">{</span><br>        <span class="token function">classpath</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.android.tools.build:gradle:7.0.4"</span></span><span class="token punctuation">)</span><br>        <span class="token function">classpath</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"me.2bab:bundle-tool-plugin:1.1.0"</span></span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><strong>0x02. Apply Plugin:</strong></p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// For your application module</span><br>plugins <span class="token punctuation">{</span><br>    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"me.2bab.bundletool"</span></span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p><strong>0x03. Advanced Configurations</strong></p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> me<span class="token punctuation">.</span>xx2bab<span class="token punctuation">.</span>bundletool<span class="token punctuation">.</span><span class="token operator">*</span><br><br>bundleTool <span class="token punctuation">{</span><br>    <span class="token comment">// This is a very interesting configuration item - it can enable/disable</span><br>    <span class="token comment">// plugin features by different variant channels. For example, here we disable</span><br>    <span class="token comment">// the debug + GET_SIZE feature combination.</span><br>    <span class="token comment">// You can adjust and enable needed features according to your project's actual buildtypes and flavors.</span><br>    enableByVariant <span class="token punctuation">{</span> variant<span class="token punctuation">,</span> feature <span class="token operator">-></span><br>        <span class="token operator">!</span><span class="token punctuation">(</span>variant<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"debug"</span></span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> feature <span class="token operator">==</span> BundleToolFeature<span class="token punctuation">.</span>GET_SIZE<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Each configuration item corresponds to a `build-apks` command execution</span><br>    buildApks <span class="token punctuation">{</span><br>        <span class="token function">create</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"universal"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            buildMode<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ApkBuildMode<span class="token punctuation">.</span>UNIVERSAL<span class="token punctuation">.</span>name<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token function">create</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"pixel4a"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            deviceSpec<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"./pixel4a.json"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Each configuration item will calculate the size of all apks output from `buildApks` above in sequence.</span><br>    <span class="token comment">// With the current configuration, it will output 2 * 1 = 2 csv files</span><br>    getSize <span class="token punctuation">{</span><br>        <span class="token function">create</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"all"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            dimensions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><br>                GetSizeDimension<span class="token punctuation">.</span>SDK<span class="token punctuation">.</span>name<span class="token punctuation">,</span><br>                GetSizeDimension<span class="token punctuation">.</span>ABI<span class="token punctuation">.</span>name<span class="token punctuation">,</span><br>                GetSizeDimension<span class="token punctuation">.</span>SCREEN_DENSITY<span class="token punctuation">.</span>name<span class="token punctuation">,</span><br>                GetSizeDimension<span class="token punctuation">.</span>LANGUAGE<span class="token punctuation">.</span>name<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><strong>0x04. Build your App and Enjoy!</strong></p>
<pre class="language-shell"><code class="language-shell"><span class="token comment"># Make sure the Variant in the command is allowed in `enableByVariant`</span><br>./gradlew TransformApksFromBundleForProductionRelease</code></pre>
<p>Finally, you can find the output results in <code>/app/outputs/bundle/${variantName}/bundletool</code>.</p>
<p><img src="https://2bab-images.lastmayday.com/20211219_bundle_tool_outputs2.png?imageslim" alt=""></p>
<h2 id="summary" tabindex="-1">Summary</h2>
<p>I hope this small tool can help everyone when integrating the new Android Bundle. The plugin is open-sourced on my Github: <a href="https://github.com/2BAB/bundle-tool-gradle-plugin">bundle-tool-gradle-plugin</a>. For the idea of enabling/disabling plugin features by Variant, please refer to the next Build Guide #12.</p>

    </div>
    <hr />
      <div class="text-sm text-center">
        For comments and further discussion, mail to xx2bab@gmail.com
      </div>
      <hr />
    
    <footer class="text-sm py-12 text-gray-500 text-center">
  
  <p><a href="/">ENG</a> / <a href="/zh">中文</a></p>
  
  2BAB's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>