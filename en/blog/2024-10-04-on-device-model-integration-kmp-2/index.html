<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="Adapting MediaPipe Demos for Kotlin Multiplatform: Object Detection" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://2bab.me/en/blog/2024-10-04-on-device-model-integration-kmp-2/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://2bab.me/">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>Adapting MediaPipe Demos for Kotlin Multiplatform: Object Detection | 2BAB&#39;s Blog</title>
  
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NFRNXW3SHS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NFRNXW3SHS');
</script>

<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/">2BAB&#39;s Blog</a>
    </div>
    <h1>Adapting MediaPipe Demos for Kotlin Multiplatform: Object Detection</h1>
    <div class="italic text-gray-500">
      2024/10/04
    </div>
    <div>
      <p>Following our previous exploration of porting Mediapipe's LLM Inference, this article delves into migrating the Object Detection Demo. By reading this, you'll learn:</p>
<ol>
<li><strong>How to port Mediapipe's official Object Detection Android Demo to Kotlin Multiplatform (KMP), enabling it to run on iOS.</strong> Project link: <a href="https://github.com/2BAB/MediaPiper/tree/object-detection">https://github.com/2BAB/MediaPiper/tree/object-detection</a></li>
<li><strong>Integrating Compose Multiplatform with iOS native controls (Camera Preview), including handling permission requests.</strong></li>
<li><strong>Tips for injecting iOS controls using dependency injection in KMP (based on Koin).</strong></li>
<li><strong>An introduction to the two Object Detection algorithms used in the Demo.</strong></li>
</ol>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-camera-ppt.png?imageslim" alt=""></p>
<h2 id="object-detection-android-sample" tabindex="-1">Object Detection Android Sample</h2>
<p>First, let's examine the original Object Detection project. You'll notice that the Android portion includes both an <code>android.view.View</code> implementation and a Jetpack Compose version. Following our previous approach, we'll directly port the Jetpack Compose version to KMP.</p>
<p>Upon closer inspection, you'll find that this app is more complex. In the LLM Inference example, the SDK only provided text inference interfaces, which we could easily wrap in Kotlin to abstract platform-specific details (though we ultimately used an alternative due to some <code>cinterop</code> support issues). The UI was entirely reusable. However, Object Detection is based on real-time image processing and includes three modes in the demo: real-time camera detection, local video detection, and local image detection. <strong>Camera preview</strong> typically <strong>relies heavily on platform-specific implementations</strong>, and players rarely use custom rendering (i.e., they use native platform solutions).</p>
<p><img src="https://2bab-images.lastmayday.com/Screenshot%202024-10-05%20at%201.25.14%E2%80%AFPM.png?imageslim" alt=""></p>
<p>In summary, from the outset, we need to <strong>reserve parts that are challenging to implement with Compose Multiplatform (CMP)</strong> (such as the <code>CameraView</code> shown above) and <strong>abstract them into separate <code>expect</code> Composable functions for each platform to implement individually</strong>. To simplify the learning process and reduce the demo's scale, we'll focus solely on implementing the <code>CameraView</code> component, leaving the Gallery (Video + Image) sections for you to explore. In essence, once you grasp how to embed a Camera Preview, you can implement the other two parts similarly, including Compose and UIKit interactions and iOS permission requests.</p>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-options-layers3.png?imageslim" alt=""></p>
<p>By cross-referencing the iOS version of the demo, we've broken down the UI layers related to <code>CameraView</code> into four components, as illustrated above:</p>
<ul>
<li>The Camera Preview layer must be implemented separately on each platform.</li>
<li>The <code>ResultOverlay</code>, which draws bounding boxes and other results, could be implemented in the common layer. However, <strong>due to complexities like matching the overlay with the Camera Preview (since the preview size can vary depending on the camera's aspect ratio) and coordinate transformations</strong>, we'll delegate this component to platform-specific implementations in this demo.</li>
<li>The <code>Scaffold</code> and <code>Inference Time Label</code> will be implemented in the common layer.</li>
</ul>
<h2 id="migration-process" tabindex="-1">Migration Process</h2>
<h3 id="porting-the-main-ui-and-data-structures" tabindex="-1">Porting the Main UI and Data Structures</h3>
<p>Building on the foundation from the previous section, we'll add a new folder named <code>objectdetection</code> to the <code>Mediapiper</code> project. With our prior experience, we realize that much of the UI content isn't overly complex—except for the focal point of this section, the camera preview interface. Therefore, we can proceed by migrating all files except for <code>camera</code> and <code>gallery</code>:</p>
<p><img src="https://2bab-images.lastmayday.com/202410121605950.png?imageslim" alt=""></p>
<p>The necessary modifications can be categorized into two areas:</p>
<ol>
<li>
<p><strong>Data and Logic:</strong></p>
<ul>
<li>Extract the <code>ObjectDetectionResult</code> declarations from original SDKs and create a common version as a data class. This allows both SDKs to convert their results into the common version, facilitating the display of inference time, unified logging, and even paving the way to potentially move <code>ResultOverlay</code> to the common layer in the future.</li>
<li>Move utility classes and default value enumerations to the common layer with minimal changes—mainly replacing references to the inference result classes with the common version.</li>
</ul>
</li>
<li>
<p><strong>UI Components:</strong></p>
<ul>
<li>Make uniform changes similar to the previous section, such as replacing <code>R</code> references with <code>Res</code>, adopting the unified theme, and adjusting some import packages.</li>
<li>Notably, this demo doesn't use the CMP version of Navigation, so switching between the Home and Option pages is handled with a simple <code>if...else...</code> at the top level.</li>
</ul>
</li>
</ol>
<p>At this point, we can run an application that doesn't include camera functionality. The images below demonstrate how these CMP codes run on iOS across two pages.</p>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-no-cameras.jpg?imageslim" alt=""></p>
<h3 id="integrating-cameraview-functionality" tabindex="-1">Integrating CameraView Functionality</h3>
<p>As previously analyzed, we need to extract the <code>CameraView</code> component for native implementation. Therefore, in the common <code>CameraView</code>, we'll use two <code>expect</code> Composable functions: <code>CameraPermissionControl</code> and <code>CameraPreview</code>:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Composable</span><br><span class="token keyword">fun</span> <span class="token function">CameraView</span><span class="token punctuation">(</span><br>    threshold<span class="token operator">:</span> Float<span class="token punctuation">,</span><br>    maxResults<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    delegate<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    mlModel<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    setInferenceTime<span class="token operator">:</span> <span class="token punctuation">(</span>newInferenceTime<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    CameraPermissionControl <span class="token punctuation">{</span><br>        <span class="token function">CameraPreview</span><span class="token punctuation">(</span><br>            threshold<span class="token punctuation">,</span><br>            maxResults<span class="token punctuation">,</span><br>            delegate<span class="token punctuation">,</span><br>            mlModel<span class="token punctuation">,</span><br>            setInferenceTime<span class="token punctuation">,</span><br>            onDetectionResultUpdate <span class="token operator">=</span> <span class="token punctuation">{</span> detectionResults <span class="token operator">-></span><br>                <span class="token comment">// ...</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">expect</span> <span class="token keyword">fun</span> <span class="token function">CameraPermissionControl</span><span class="token punctuation">(</span>PermissionGrantedContent<span class="token operator">:</span> <span class="token annotation builtin">@Composable</span> <span class="token annotation builtin">@UiComposable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span><br><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">expect</span> <span class="token keyword">fun</span> <span class="token function">CameraPreview</span><span class="token punctuation">(</span><br>    threshold<span class="token operator">:</span> Float<span class="token punctuation">,</span><br>    maxResults<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    delegate<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    mlModel<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    setInferenceTime<span class="token operator">:</span> <span class="token punctuation">(</span>newInferenceTime<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br>    onDetectionResultUpdate<span class="token operator">:</span> <span class="token punctuation">(</span>result<span class="token operator">:</span> ObjectDetectionResult<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<br><span class="token punctuation">)</span></code></pre>
<h4 id="android-implementation" tabindex="-1">Android Implementation</h4>
<p>The Android side is straightforward—we can directly copy the original Jetpack Compose code:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// Android implementation</span><br><span class="token annotation builtin">@OptIn</span><span class="token punctuation">(</span>ExperimentalPermissionsApi<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">actual</span> <span class="token keyword">fun</span> <span class="token function">CameraPermissionControl</span><span class="token punctuation">(</span><br>    PermissionGrantedContent<span class="token operator">:</span> <span class="token annotation builtin">@Composable</span> <span class="token annotation builtin">@UiComposable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<br><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">val</span> storagePermissionState<span class="token operator">:</span> PermissionState <span class="token operator">=</span><br>        <span class="token function">rememberPermissionState</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">)</span><br>    <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>key1 <span class="token operator">=</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storagePermissionState<span class="token punctuation">.</span>hasPermission<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            storagePermissionState<span class="token punctuation">.</span><span class="token function">launchPermissionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storagePermissionState<span class="token punctuation">.</span>hasPermission<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">Text</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No Storage Permission!"</span></span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token function">PermissionGrantedContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">actual</span> <span class="token keyword">fun</span> <span class="token function">CameraPreview</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Define properties</span><br><br>    <span class="token function">DisposableEffect</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        onDispose <span class="token punctuation">{</span><br>            active <span class="token operator">=</span> <span class="token boolean">false</span><br>            cameraProviderFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unbindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Describe the UI of this camera view</span><br>    BoxWithConstraints <span class="token punctuation">{</span><br>        <span class="token keyword">val</span> cameraPreviewSize <span class="token operator">=</span> <span class="token function">getFittedBoxSize</span><span class="token punctuation">(</span><br>            containerSize <span class="token operator">=</span> <span class="token function">Size</span><span class="token punctuation">(</span><br>                width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxWidth<span class="token punctuation">.</span>value<span class="token punctuation">,</span><br>                height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxHeight<span class="token punctuation">.</span>value<span class="token punctuation">,</span><br>            <span class="token punctuation">)</span><span class="token punctuation">,</span><br>            boxSize <span class="token operator">=</span> <span class="token function">Size</span><span class="token punctuation">(</span><br>                width <span class="token operator">=</span> frameWidth<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                height <span class="token operator">=</span> frameHeight<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br><br>        <span class="token function">Box</span><span class="token punctuation">(</span><br>            Modifier<br>                <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span>cameraPreviewSize<span class="token punctuation">.</span>width<span class="token punctuation">.</span>dp<span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span>cameraPreviewSize<span class="token punctuation">.</span>height<span class="token punctuation">.</span>dp<span class="token punctuation">)</span><br>        <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token comment">// Use AndroidView to integrate CameraX, as there's no prebuilt composable in Jetpack Compose</span><br>            <span class="token function">AndroidView</span><span class="token punctuation">(</span><br>                factory <span class="token operator">=</span> <span class="token punctuation">{</span> ctx <span class="token operator">-></span><br>                    <span class="token keyword">val</span> previewView <span class="token operator">=</span> <span class="token function">PreviewView</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><br>                    <span class="token keyword">val</span> executor <span class="token operator">=</span> ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><br>                    cameraProviderFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>                        <span class="token keyword">val</span> cameraProvider <span class="token operator">=</span> cameraProviderFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                        <span class="token keyword">val</span> preview <span class="token operator">=</span> Preview<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span><br>                            it<span class="token punctuation">.</span><span class="token function">setSurfaceProvider</span><span class="token punctuation">(</span>previewView<span class="token punctuation">.</span>surfaceProvider<span class="token punctuation">)</span><br>                        <span class="token punctuation">}</span><br><br>                        <span class="token keyword">val</span> cameraSelector <span class="token operator">=</span> CameraSelector<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                            <span class="token punctuation">.</span><span class="token function">requireLensFacing</span><span class="token punctuation">(</span>CameraSelector<span class="token punctuation">.</span>LENS_FACING_BACK<span class="token punctuation">)</span><br>                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>                        <span class="token comment">// Instantiate an image analyzer for frame transformations before object detection</span><br>                        <span class="token keyword">val</span> imageAnalyzer <span class="token operator">=</span> ImageAnalysis<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                            <span class="token punctuation">.</span><span class="token function">setTargetAspectRatio</span><span class="token punctuation">(</span>AspectRatio<span class="token punctuation">.</span>RATIO_4_3<span class="token punctuation">)</span><br>                            <span class="token punctuation">.</span><span class="token function">setBackpressureStrategy</span><span class="token punctuation">(</span>ImageAnalysis<span class="token punctuation">.</span>STRATEGY_KEEP_ONLY_LATEST<span class="token punctuation">)</span><br>                            <span class="token punctuation">.</span><span class="token function">setOutputImageFormat</span><span class="token punctuation">(</span>ImageAnalysis<span class="token punctuation">.</span>OUTPUT_IMAGE_FORMAT_RGBA_8888<span class="token punctuation">)</span><br>                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>                        <span class="token comment">// Execute object detection in a new thread</span><br>                        <span class="token keyword">val</span> backgroundExecutor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>                        backgroundExecutor<span class="token punctuation">.</span><span class="token function">execute</span> <span class="token punctuation">{</span><br>                            <span class="token comment">// Use ObjectDetectorHelper to abstract Mediapipe specifics</span><br>                            <span class="token keyword">val</span> objectDetectorHelper <span class="token operator">=</span> <span class="token function">AndroidObjectDetector</span><span class="token punctuation">(</span><br>                                context <span class="token operator">=</span> ctx<span class="token punctuation">,</span><br>                                threshold <span class="token operator">=</span> threshold<span class="token punctuation">,</span><br>                                currentDelegate <span class="token operator">=</span> delegate<span class="token punctuation">,</span><br>                                currentModel <span class="token operator">=</span> mlModel<span class="token punctuation">,</span><br>                                maxResults <span class="token operator">=</span> maxResults<span class="token punctuation">,</span><br>                                objectDetectorListener <span class="token operator">=</span> <span class="token function">ObjectDetectorListener</span><span class="token punctuation">(</span><br>                                    onErrorCallback <span class="token operator">=</span> <span class="token punctuation">{</span> _<span class="token punctuation">,</span> _ <span class="token operator">-></span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                                    onResultsCallback <span class="token operator">=</span> <span class="token punctuation">{</span><br>                                        <span class="token comment">// Set frame dimensions upon receiving results</span><br>                                        frameHeight <span class="token operator">=</span> it<span class="token punctuation">.</span>inputImageHeight<br>                                        frameWidth <span class="token operator">=</span> it<span class="token punctuation">.</span>inputImageWidth<br><br>                                        <span class="token comment">// Update results and inference time if the view is active</span><br>                                        <span class="token keyword">if</span> <span class="token punctuation">(</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                                            results <span class="token operator">=</span> it<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                                            <span class="token function">setInferenceTime</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>inferenceTime<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>                                        <span class="token punctuation">}</span><br>                                    <span class="token punctuation">}</span><br>                                <span class="token punctuation">)</span><span class="token punctuation">,</span><br>                                runningMode <span class="token operator">=</span> RunningMode<span class="token punctuation">.</span>LIVE_STREAM<br>                            <span class="token punctuation">)</span><br><br>                            <span class="token comment">// Set the analyzer and start detecting objects from the live stream</span><br>                            imageAnalyzer<span class="token punctuation">.</span><span class="token function">setAnalyzer</span><span class="token punctuation">(</span><br>                                backgroundExecutor<span class="token punctuation">,</span><br>                                objectDetectorHelper<span class="token operator">::</span>detectLivestreamFrame<br>                            <span class="token punctuation">)</span><br>                        <span class="token punctuation">}</span><br><br>                        <span class="token comment">// Unbind any currently open camera and bind our own</span><br>                        cameraProvider<span class="token punctuation">.</span><span class="token function">unbindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                        cameraProvider<span class="token punctuation">.</span><span class="token function">bindToLifecycle</span><span class="token punctuation">(</span><br>                            lifecycleOwner<span class="token punctuation">,</span><br>                            cameraSelector<span class="token punctuation">,</span><br>                            imageAnalyzer<span class="token punctuation">,</span><br>                            preview<br>                        <span class="token punctuation">)</span><br>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><br>                    <span class="token comment">// Return the preview view from the AndroidView factory</span><br>                    previewView<br>                <span class="token punctuation">}</span><span class="token punctuation">,</span><br>                modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br><br>            <span class="token comment">// Display the results overlay if there are current results</span><br>            results<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span><br>                <span class="token function">ResultsOverlay</span><span class="token punctuation">(</span><br>                    results <span class="token operator">=</span> it<span class="token punctuation">,</span><br>                    frameWidth <span class="token operator">=</span> frameWidth<span class="token punctuation">,</span><br>                    frameHeight <span class="token operator">=</span> frameHeight<br>                <span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h4 id="ios-implementation" tabindex="-1">iOS Implementation</h4>
<p>The iOS side requires a bit more effort. For camera permission control, we'll directly call iOS's <code>platform.AVFoundation</code> APIs within this Composable function, asynchronously request permissions, and display appropriate messages based on the result—loading, failure, or success, where we show the camera preview. You'll notice that our iOS implementation is quite comprehensive, covering all three scenarios.</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> platform<span class="token punctuation">.</span>AVFoundation<span class="token punctuation">.</span><span class="token operator">*</span><br><span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>resume<br><span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>suspendCoroutine<br><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">actual</span> <span class="token keyword">fun</span> <span class="token function">CameraPermissionControl</span><span class="token punctuation">(</span>PermissionGrantedContent<span class="token operator">:</span> <span class="token annotation builtin">@Composable</span> <span class="token annotation builtin">@UiComposable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> hasCameraPermission <span class="token keyword">by</span> remember <span class="token punctuation">{</span> mutableStateOf<span class="token operator">&lt;</span>Boolean<span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br><br>    <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        hasCameraPermission <span class="token operator">=</span> <span class="token function">requestCameraAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">when</span> <span class="token punctuation">(</span>hasCameraPermission<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token boolean">true</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            <span class="token function">PermissionGrantedContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token boolean">false</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Camera permission denied. Please grant access from settings."</span></span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Requesting camera permission..."</span></span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">private</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">requestCameraAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> suspendCoroutine <span class="token punctuation">{</span> continuation <span class="token operator">-></span><br>    <span class="token keyword">val</span> authorizationStatus <span class="token operator">=</span> AVCaptureDevice<span class="token punctuation">.</span><span class="token function">authorizationStatusForMediaType</span><span class="token punctuation">(</span>AVMediaTypeVideo<span class="token punctuation">)</span><br><br>    <span class="token keyword">when</span> <span class="token punctuation">(</span>authorizationStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        AVAuthorizationStatusNotDetermined <span class="token operator">-></span> <span class="token punctuation">{</span><br>            AVCaptureDevice<span class="token punctuation">.</span><span class="token function">requestAccessForMediaType</span><span class="token punctuation">(</span>AVMediaTypeVideo<span class="token punctuation">)</span> <span class="token punctuation">{</span> granted <span class="token operator">-></span><br>                continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>granted<span class="token punctuation">)</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        AVAuthorizationStatusRestricted<span class="token punctuation">,</span> AVAuthorizationStatusDenied <span class="token operator">-></span> <span class="token punctuation">{</span><br>            continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        AVAuthorizationStatusAuthorized <span class="token operator">-></span> <span class="token punctuation">{</span><br>            continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Now, let's tackle the core camera preview functionality. According to the <a href="https://www.jetbrains.com/help/kotlin-multiplatform-dev/compose-uikit-integration.html">CMP documentation</a>, we can embed a UIKit view within a Composable function using <code>UIKitView</code>:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// Example 1</span><br><span class="token function">UIKitView</span><span class="token punctuation">(</span><br>    factory <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function">MKMapView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span><br><br><span class="token comment">// Example 2</span><br><span class="token annotation builtin">@OptIn</span><span class="token punctuation">(</span>ExperimentalForeignApi<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">fun</span> <span class="token function">UseUITextField</span><span class="token punctuation">(</span>modifier<span class="token operator">:</span> Modifier <span class="token operator">=</span> Modifier<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> message <span class="token keyword">by</span> remember <span class="token punctuation">{</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Hello, World!"</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>    <span class="token function">UIKitView</span><span class="token punctuation">(</span><br>        factory <span class="token operator">=</span> <span class="token punctuation">{</span><br>            <span class="token keyword">val</span> textField <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">UITextField</span><span class="token punctuation">(</span><span class="token function">CGRectMake</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token annotation builtin">@ObjCAction</span><br>                <span class="token keyword">fun</span> <span class="token function">editingChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    message <span class="token operator">=</span> text <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">""</span></span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>            textField<span class="token punctuation">.</span><span class="token function">addTarget</span><span class="token punctuation">(</span><br>                target <span class="token operator">=</span> textField<span class="token punctuation">,</span><br>                action <span class="token operator">=</span> <span class="token function">NSSelectorFromString</span><span class="token punctuation">(</span>textField<span class="token operator">::</span>editingChanged<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span><br>                forControlEvents <span class="token operator">=</span> UIControlEventEditingChanged<br>            <span class="token punctuation">)</span><br>            textField<br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        modifier <span class="token operator">=</span> modifier<span class="token punctuation">.</span><span class="token function">fillMaxWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        update <span class="token operator">=</span> <span class="token punctuation">{</span> textField <span class="token operator">-></span><br>            textField<span class="token punctuation">.</span>text <span class="token operator">=</span> message<br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>These examples applied some default iOS components, not custom ones. The corresponding reference headers are already converted to Kotlin by JetBrains, such as <code>platform.UIKit.UITextField</code>, which can be directly imported into the KMP project's iOS target.</p>
<p><img src="https://2bab-images.lastmayday.com/202410131137759.png?imageslim" alt=""></p>
<p>In our case, we want to reuse a custom <code>CameraPreview</code> view with recognition capabilities. However, the <code>app.framework</code> produced by KMP is a shared layer upon which the iOS native code depends. <strong>Due to the dependency hierarchy, we can't directly call <code>CameraPreview</code> defined in the iOS app's source code</strong>. There are generally two solutions:</p>
<ol>
<li>Package the relevant code into a separate module, producing <code>cameraview.framework</code>, which the KMP's <code>app</code> can depend on.</li>
<li>When initializing <code>app.framework</code> in the iOS app, pass a lambda that initializes and returns a <code>UIView</code> to <code>app</code>.</li>
</ol>
<p>We'll opt for the second solution, defining <code>IOSCameraPreviewCreator</code> as the protocol for interaction between the two sides.</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// Definition</span><br><span class="token keyword">typealias</span> IOSCameraPreviewCreator <span class="token operator">=</span> <span class="token punctuation">(</span><br>    threshold<span class="token operator">:</span> Float<span class="token punctuation">,</span><br>    maxResults<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    delegate<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    mlModel<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    setInferenceTime<span class="token operator">:</span> <span class="token punctuation">(</span>newInferenceTime<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br>    callback<span class="token operator">:</span> IOSCameraPreviewCallback<br><span class="token punctuation">)</span> <span class="token operator">-></span> UIView<br><br><span class="token keyword">typealias</span> IOSCameraPreviewCallback <span class="token operator">=</span> <span class="token punctuation">(</span>result<span class="token operator">:</span> ObjectDetectionResult<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<br><br><span class="token comment">// Inject the implementation from the iOS side during startup and add it to Koin's definitions</span><br><span class="token keyword">fun</span> <span class="token function">onStartup</span><span class="token punctuation">(</span>iosCameraPreviewCreator<span class="token operator">:</span> IOSCameraPreviewCreator<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    Startup<span class="token punctuation">.</span><span class="token function">run</span> <span class="token punctuation">{</span> koinApp <span class="token operator">-></span><br>        koinApp<span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span><br>            <span class="token function">modules</span><span class="token punctuation">(</span>module <span class="token punctuation">{</span><br>                single <span class="token punctuation">{</span> <span class="token function">LLMOperatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>                single<span class="token operator">&lt;</span>IOSCameraPreviewCreator<span class="token operator">></span> <span class="token punctuation">{</span> iosCameraPreviewCreator <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// In the implementation of CameraPreview, </span><br><span class="token comment">// we inject and invoke this function to obtain a UIView instance</span><br><span class="token keyword">import</span> androidx<span class="token punctuation">.</span>compose<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>viewinterop<span class="token punctuation">.</span>UIKitView<br><span class="token keyword">import</span> platform<span class="token punctuation">.</span>UIKit<span class="token punctuation">.</span>UIView<br><br><span class="token annotation builtin">@Composable</span><br><span class="token keyword">actual</span> <span class="token keyword">fun</span> <span class="token function">CameraPreview</span><span class="token punctuation">(</span><br>    threshold<span class="token operator">:</span> Float<span class="token punctuation">,</span><br>    maxResults<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    delegate<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    mlModel<span class="token operator">:</span> Int<span class="token punctuation">,</span><br>    setInferenceTime<span class="token operator">:</span> <span class="token punctuation">(</span>newInferenceTime<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br>    onDetectionResultUpdate<span class="token operator">:</span> <span class="token punctuation">(</span>result<span class="token operator">:</span> ObjectDetectionResult<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span><br><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">val</span> iOSCameraPreviewCreator <span class="token operator">=</span> koinInject<span class="token operator">&lt;</span>IOSCameraPreviewCreator<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token comment">// Similar to how Android integrates the native Camera View</span><br>    <span class="token function">UIKitView</span><span class="token punctuation">(</span><br>        factory <span class="token operator">=</span> <span class="token punctuation">{</span><br>            <span class="token keyword">val</span> iosCameraPreview<span class="token operator">:</span> UIView <span class="token operator">=</span> <span class="token function">iOSCameraPreviewCreator</span><span class="token punctuation">(</span><br>                threshold<span class="token punctuation">,</span><br>                maxResults<span class="token punctuation">,</span><br>                delegate<span class="token punctuation">,</span><br>                mlModel<span class="token punctuation">,</span><br>                setInferenceTime<span class="token punctuation">,</span><br>                onDetectionResultUpdate<br>            <span class="token punctuation">)</span><br>            iosCameraPreview<br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        update <span class="token operator">=</span> <span class="token punctuation">{</span> _ <span class="token operator">-></span> <span class="token punctuation">}</span><br>    <span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>The above code leverages Koin for dependency injection, simplifying the interaction process. Now, let's follow the injection of startup parameters to check the iOS side.</p>
<pre class="language-swift"><code class="language-swift"><span class="token class-name">MainKt</span><span class="token punctuation">.</span><span class="token function">onStartup</span><span class="token punctuation">(</span>iosCameraPreviewCreator<span class="token punctuation">:</span> <span class="token punctuation">{</span> threshold<span class="token punctuation">,</span> maxResults<span class="token punctuation">,</span> delegate<span class="token punctuation">,</span> mlModel<span class="token punctuation">,</span> onInferenceTimeUpdate<span class="token punctuation">,</span> resultCallback <span class="token keyword">in</span><br>    <span class="token keyword">return</span> <span class="token class-name">IOSCameraView</span><span class="token punctuation">(</span><br>        frame<span class="token punctuation">:</span> <span class="token class-name">CGRectMake</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        modelName<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">(</span>truncating<span class="token punctuation">:</span> mlModel<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string-literal"><span class="token string">"EfficientDet-Lite0"</span></span> <span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"EfficientDet-Lite2"</span></span><span class="token punctuation">,</span><br>        maxResults<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">(</span>truncating<span class="token punctuation">:</span> maxResults<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        scoreThreshold<span class="token punctuation">:</span> <span class="token class-name">Float</span><span class="token punctuation">(</span>truncating<span class="token punctuation">:</span> threshold<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        onInferenceTimeUpdate<span class="token punctuation">:</span> onInferenceTimeUpdate<span class="token punctuation">,</span><br>        resultCallback<span class="token punctuation">:</span> resultCallback<br>    <span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>The <code>IOSCameraView</code> here is essentially the <code>CameraViewController</code> from the original iOS demo. We've modified some initialization and lifecycle content and simplified parameter change listeners to highlight the core migration aspects:</p>
<ol>
<li>
<p><strong>Lifecycle Handling</strong>: <code>ViewController</code> uses methods like <code>viewDidLoad</code>, while <code>UIView</code> uses <code>didMoveToWindow</code> to handle logic when the view is added or removed. <code>ViewController</code> initializes through its lifecycle, whereas <code>UIView</code> provides custom initializers to pass in models and detection parameters.</p>
</li>
<li>
<p><strong>Subview Setup</strong>: <code>ViewController</code> uses <code>@IBOutlet</code> and Interface Builder, while <code>UIView</code> directly creates and adds subviews via a <code>setupView</code> method, manually setting constraints with AutoLayout and handling tap events.</p>
</li>
<li>
<p><strong>Callbacks and Delegates</strong>: <code>ViewController</code> uses delegates, while <code>UIView</code> adds closure callbacks like <code>onInferenceTimeUpdate</code> and <code>resultCallback</code>. These are passed during initialization and set up for type conversion, facilitating callbacks to the KMP layer.</p>
</li>
</ol>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-controller-to-view.jpg?imageslim" alt=""></p>
<p>We also retain <code>OverlayView</code>, <code>CameraFeedService</code>, <code>ObjectDetectorService</code>, and parts of <code>DefaultConstants</code>, without modifying their code. Notably, <code>ObjectDetectorService</code> encapsulates the Object Detection SDK. If you examine its API calls, you'll find it's closely coupled with iOS's Camera APIs (like <code>CMSampleBuffer</code>), indicating the difficulty of abstracting it into the common layer.</p>
<p><img src="https://2bab-images.lastmayday.com/202410131208100.png?imageslim" alt=""></p>
<p>With this, we can run the camera preview with Object Detection on iOS.</p>
<h2 id="simple-testing" tabindex="-1">Simple Testing</h2>
<p><img src="https://2bab-images.lastmayday.com/20241004-object-detection-overview-gif.gif?imageslim" alt=""></p>
<p>The above GIF showcases the performance of EfficientDet-Lite0 running in CPU mode on an iPhone 13 mini. In official tests using the Pixel 6's CPU/GPU, switching to GPU execution can slightly improve performance. It's evident that the real-time performance is sufficient for production environments, and the accuracy is acceptable.</p>
<p><img src="https://2bab-images.lastmayday.com/202410131403617.png?imageslim" alt=""></p>
<p>The demo comes with two optional models:</p>
<ul>
<li><strong>EfficientDet-Lite0</strong>: Uses 320x320 input, balancing latency and accuracy, suitable for lightweight applications. The demo includes its float32 version by default.</li>
<li><strong>EfficientDet-Lite2</strong>: Uses 448x448 input, offering higher accuracy at the cost of speed, suitable for scenarios demanding greater precision. The demo includes its float32 version by default.</li>
</ul>
<p>Both models are trained on a dataset containing 1.5 million instances and 80 object labels.</p>
<h2 id="summary" tabindex="-1">Summary</h2>
<ul>
<li>Traditional ML models on mobile devices are relatively mature and can handle many specific scenarios. The two models discussed are only 13–25 MB in size. Compared to LLM models that are often over 1 GB, these models are much more practical for deployment.</li>
<li>Embedding UIKit views within Compose Multiplatform allows us to address high-performance needs that require native APIs and hardware.</li>
<li>We kept <code>ResultOverlay</code> in the common layer, and the iOS side set up result callbacks to the KMP layer. However, on iOS, we still used native views for implementation due to the cost of migration. In real-world scenarios, we can further consider:
<ul>
<li>If the business scenario is simple, such as rectangle recognition with a full-screen camera preview, we can easily reuse <code>ResultOverlay</code> at the Compose layer.</li>
<li>For complex business scenarios, like facial recognition with sticker selection and rendering during video chats, the high complexity of the business logic makes reusing the same <code>StickerOverlay</code> highly valuable. In this case, regardless of the camera preview size, the cost of adaptation becomes acceptable. Moreover, there's potential for optimization in calculations within <code>StickerOverlay</code>, such as using sampled calculations and interpolated animations.</li>
</ul>
</li>
<li>Complex dependency management scenarios, including UI view injection, can be  simplified using dependency injection frameworks like Koin.</li>
</ul>

    </div>
    <hr />
      <div class="text-sm text-center">
        For comments and further discussion, mail to xx2bab@gmail.com
      </div>
      <hr />
    
    <footer class="text-sm py-12 text-gray-500 text-center">
  
  <p><a href="/">ENG</a> / <a href="/zh">中文</a></p>
  
  2BAB's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>